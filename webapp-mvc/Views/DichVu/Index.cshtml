@model webapp_mvc.Models.DichVuViewModel
@{
    ViewData["Title"] = "Chọn Dịch Vụ";
}

<!-- Hero Banner (Full Width) -->
<div class="position-relative w-100 d-flex align-items-center justify-content-center mb-5" 
     style="height: 500px; background: url('@Url.Content("~/images/hero_bg.jpg")') center/cover no-repeat; padding-top: 85px; z-index: 1;">
    <!-- Dark Overlay -->
    <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(to right, rgba(0,0,0,0.7), rgba(0,0,0,0.4));"></div>
    
    <div class="text-center position-relative fade-in-up px-3" style="z-index: 2;">
        <h1 class="display-3 fw-bold text-white mb-3" style="text-shadow: 0 4px 10px rgba(0,0,0,0.5); letter-spacing: 1px; text-transform: uppercase;">
            DỊCH VỤ <span style="color: var(--color-lime);">TIỆN ÍCH</span>
        </h1>
        <p class="lead text-light fs-5 opacity-90 mb-4 mx-auto" style="max-width: 800px;">
            Chọn thêm nước uống, dụng cụ hoặc thuê huấn luyện viên.<br class="d-none d-md-block">
            Nâng tầm trải nghiệm thể thao của bạn tại ViệtSport.
        </p>
         <!-- Info Ticket (Floating) -->
        @if (!string.IsNullOrEmpty(Model.ThongTinSan))
        {
            <div class="mt-4 fade-in-up" style="animation-delay: 0.2s;">
               <div class="d-inline-block bg-white text-dark py-2 px-4 fw-bold rounded-pill shadow-lg border border-2 border-lime">
                   <i class="fas fa-ticket-alt me-2 text-warning"></i> @Model.ThongTinSan
                   @if (ViewBag.TienSanTamTinh != null)
                   {
                        <span class="d-none d-md-inline text-muted mx-2">|</span> <br class="d-md-none" />
                        <span class="text-success"><i class="fas fa-coins me-1"></i>Giá sân: @ViewBag.TienSanTamTinh đ</span>
                   }
               </div>
            </div>
        }
    </div>
</div>

<div class="container py-4">

    @if (ViewBag.Message != null)
    {
        <div class="alert alert-danger border-0 shadow-sm rounded-4 mb-4" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i> @ViewBag.Message
        </div>
    }

    <!-- Filter Bar (DatSan Style Clone) -->
    <div class="card border-0 mb-5 fade-in-up" 
         style="background: #ffffff; border-radius: 20px; border: 5px solid #a3cf06; box-shadow: 0 0 20px rgba(163, 207, 6, 0.2);">
        <div class="card-body p-3 px-md-4">
            <form method="get" asp-action="Index" class="row g-2 align-items-end">
                <input type="hidden" name="maDatSan" value="@Model.MaDatSan" />
                
                <!-- Facility (Read-only) -->
                <div class="col-md-3">
                    <label class="form-label text-dark fw-bold ms-1 small" style="font-size: 0.8rem;"><i class="fas fa-map-marker-alt me-1 text-warning"></i>CƠ SỞ</label>
                    <input type="text" class="form-control form-control-sm py-2 fw-bold shadow-sm border-2 bg-light" 
                           value="@(ViewBag.TenCoSo ?? "Đang tải...")" readonly style="cursor: not-allowed;">
                    <input type="hidden" name="filterMaCS" value="@ViewBag.CurrentMaCS" />
                </div>
                
                <!-- Date -->
                <div class="col-md-2">
                    <label class="form-label text-dark fw-bold ms-1 small" style="font-size: 0.8rem;"><i class="fas fa-calendar me-1 text-primary"></i>NGÀY</label>
                    <input type="date" name="ngayDat" value="@Model.NgayDat.ToString("yyyy-MM-dd")" class="form-control form-control-sm py-2 fw-bold shadow-sm border-2">
                </div>
                
                <!-- Time Range -->
                <div class="col-md-5">
                     <label class="form-label text-dark fw-bold ms-1 small" style="font-size: 0.8rem;"><i class="fas fa-clock me-1 text-info"></i>KHUNG GIỜ</label>
                     <div class="input-group input-group-sm">
                        <input type="time" name="gioBatDau" value="@Model.GioBatDau.ToString(@"hh\:mm")" class="form-control py-2 fw-bold shadow-sm border-end-0 border-2">
                        <span class="input-group-text bg-white border-top border-bottom border-2 text-secondary px-1">➜</span>
                        <input type="time" name="gioKetThuc" value="@Model.GioKetThuc.ToString(@"hh\:mm")" class="form-control py-2 fw-bold shadow-sm border-start-0 border-2">
                     </div>
                </div>
                
                <!-- Button -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-sm w-100 py-2 fw-bold shadow-sm hover-scale" 
                            style="background: var(--color-lime); color: var(--color-dark); border-radius: 8px; border: none; font-size: 0.9rem; margin-top: 1.8rem;">
                        <i class="fas fa-filter me-1"></i> LỌC
                    </button>
                </div>
            </form>
        </div>
    </div>

    <form method="post" asp-action="Index">
        <input type="hidden" asp-for="MaDatSan" />
        <input type="hidden" name="FilterMaCS" value="@ViewBag.CurrentMaCS" />
        <input type="hidden" asp-for="NgayDat" />
        <input type="hidden" asp-for="GioBatDau" />
        <input type="hidden" asp-for="GioKetThuc" />
        
        <div class="row g-4 justify-content-center" id="service-grid">
            @for (int i = 0; i < Model.DanhSachDichVu.Count; i++)
            {
                var item = Model.DanhSachDichVu[i];
                
                // Determine Category for Image Mapping & Logic Control
                var category = "other";
                var loaiLower = item.LoaiDV?.ToLower() ?? "";
                var nameLower = item.TenDV?.ToLower() ?? "";
                var imgSrc = item.HinhAnh?.Trim();

                if (loaiLower.Contains("nước") || loaiLower.Contains("đồ uống")) category = "Nước";
                else if (loaiLower.Contains("vợt") || loaiLower.Contains("dụng cụ")) category = "Vợt"; 
                else if (loaiLower.Contains("bóng")) category = "Bóng";
                else if (loaiLower.Contains("huấn luyện") || loaiLower.Contains("hlv")) category = "Huấn luyện";
                else if (loaiLower.Contains("vip") || loaiLower.Contains("phòng")) category = "Phòng";
                else if (loaiLower.Contains("tủ") || loaiLower.Contains("locker")) category = "Tủ";
                else if (loaiLower.Contains("ăn") || loaiLower.Contains("food")) category = "Food";
                else if (loaiLower.Contains("massage")) category = "Massage";
                else if (loaiLower.Contains("xe")) category = "Xe";

                // Fallback Image Logic (Using stable placeholders)
                if (string.IsNullOrEmpty(imgSrc))
                {
                    if (category == "Huấn luyện") imgSrc = "https://placehold.co/600x400/2c3e50/ffffff?text=Huan+Luyen+Vien";
                    else if (category == "Nước") imgSrc = "https://placehold.co/600x400/3498db/ffffff?text=Nuoc+Uong";
                    else if (category == "Vợt") imgSrc = "https://placehold.co/600x400/e67e22/ffffff?text=Dung+Cu+The+Thao";
                    else if (category == "Bóng") imgSrc = "https://placehold.co/600x400/2ecc71/ffffff?text=Bong+Thi+Dau";
                    else if (category == "Phòng") imgSrc = "https://placehold.co/600x400/9b59b6/ffffff?text=Phong+VIP";
                    else if (category == "Tủ") imgSrc = "https://placehold.co/600x400/95a5a6/ffffff?text=Tu+Do";
                    else if (category == "Food") imgSrc = "https://placehold.co/600x400/f1c40f/ffffff?text=Do+An+Nhe";
                    else if (category == "Massage") imgSrc = "https://placehold.co/600x400/e74c3c/ffffff?text=Massage";
                    else if (category == "Xe") imgSrc = "https://placehold.co/600x400/34495e/ffffff?text=Thue+Xe";
                    else imgSrc = "https://placehold.co/600x400/7f8c8d/ffffff?text=Dich+Vu+Khac";
                }

                <div class="col-md-6 col-lg-4 col-xl-3 service-item fade-in-up" data-category="@item.LoaiDV">
                    <div class="card h-100 border-0 shadow-sm hover-elevate position-relative overflow-hidden" 
                         style="border-radius: 20px; background: rgba(255,255,255,0.95);">
                         
                        <input type="hidden" asp-for="DanhSachDichVu[i].MaDV" />
                        <input type="hidden" asp-for="DanhSachDichVu[i].TenDV" /> 
                        <input type="hidden" asp-for="DanhSachDichVu[i].LoaiDV" />

                        <!-- Badge Price (Top Right) -->
                        <div class="position-absolute top-0 end-0 m-3 px-3 py-1 rounded-pill fw-bold shadow-sm" 
                             style="background: var(--color-lime); color: var(--color-dark); z-index: 2;">
                            @Model.DanhSachDichVu[i].DonGia.ToString("N0") đ @(string.IsNullOrEmpty(Model.DanhSachDichVu[i].DVT) ? "" : "/ " + Model.DanhSachDichVu[i].DVT)
                        </div>

                        <!-- Image Area -->
                        <div class="bg-light d-flex align-items-center justify-content-center position-relative overflow-hidden" style="height: 180px;">
                            <img src="@imgSrc" alt="@item.TenDV" class="w-100 h-100 object-fit-cover transition-transform hover-zoom" referrerpolicy="no-referrer" loading="lazy">
                        </div>

                        <div class="card-body p-4 d-flex flex-column">
                            <div class="mb-2 d-flex flex-row align-items-center flex-wrap gap-1" style="min-height: 24px;"> <!-- Min-height to stabilize -->
                                @if (!string.IsNullOrEmpty(item.TenCS))
                                {
                                    <span class="badge bg-light text-secondary border" style="font-size: 0.75rem;">@item.TenCS</span>
                                }
                                <span class="badge bg-light text-secondary border" style="font-size: 0.75rem;">@item.LoaiDV</span>
                                @if (item.ChuyenMon != null) 
                                {
                                    <span class="badge border text-truncate mw-100" style="background: rgba(206, 255, 0, 0.15); color: var(--color-dark); border-color: var(--color-lime) !important; font-size: 0.75rem; max-width: 140px;">
                                        @item.ChuyenMon
                                    </span>
                                }
                            </div>
                            
                            <h4 class="card-title fw-bold mb-3 text-dark text-truncate" title="@item.TenDV">
                                @item.TenDV
                            </h4>
                            
                            <!-- Control Area -->
                            <div class="mt-4">
                                @if (category == "Huấn luyện" || category == "Phòng" || category == "Tủ")
                                {
                                    <input type="hidden" asp-for="DanhSachDichVu[i].SoLuong" id="qty-@i" value="0" />
                                    <!-- Button style Dark + No Icon Plus -->
                                    <button type="button" class="btn w-100 py-2 fw-bold rounded-3 shadow-sm btn-hlv-toggle transition-all" 
                                            style="background: var(--color-dark); color: white; border: none;"
                                            id="btn-hlv-@i" onclick="toggleHLV(@i)">
                                        @if (category == "Huấn luyện") { <text>Chọn HLV</text> }
                                        else if (category == "Phòng") { <text>Chọn Phòng VIP</text> }
                                        else if (category == "Tủ") { <text>Chọn Tủ Đồ</text> }
                                    </button>
                                }
                                else
                                {
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex flex-column">
                                            <span class="text-secondary fw-bold small">Số lượng:</span>
                                            <span class="text-muted fst-italic" style="font-size: 0.7rem;">(Có sẵn: @item.SoLuongTon)</span>
                                        </div>
                                        <div class="input-group input-group-sm w-50 border rounded-pill overflow-hidden shadow-sm">
                                            <button type="button" class="btn btn-light bg-white border-end px-2" onclick="adjustQty(@i, -1)">
                                                <i class="fas fa-minus text-secondary"></i>
                                            </button>
                                            <input type="number" asp-for="DanhSachDichVu[i].SoLuong" id="qty-@i" 
                                                   class="form-control text-center border-0 fw-bold bg-white p-0 text-dark" value="0" min="0" max="@item.SoLuongTon" readonly />
                                            <button type="button" class="btn btn-light bg-white border-start px-2" onclick="adjustQty(@i, 1)">
                                                <i class="fas fa-plus text-secondary"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                        
                        <!-- Selected Indicator Overlay -->
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-none flex-column align-items-center justify-content-center selected-overlay"
                             id="overlay-@i"
                             style="background: rgba(206, 232, 48, 0.95); z-index: 10;">
                             <div class="text-center">
                                 <i class="fas fa-check-circle fa-4x text-dark mb-3"></i>
                                 <h4 class="text-dark fw-bold">Đã chọn</h4>
                                 <p class="text-dark fw-bold h3 mb-0" id="overlay-qty-@i">x1</p>
                             </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (Model.DanhSachDichVu.Count == 0)
        {
            <div class="text-center py-5">
                <p class="text-muted">Không có dịch vụ nào trong hệ thống.</p>
            </div>
        }

        <div class="d-flex justify-content-center mt-5 mb-5 pb-5 gap-3">
            <a asp-action="Index" asp-controller="Home" class="btn btn-outline-secondary px-5 py-3 rounded-pill fw-bold shadow-sm hover-scale">
                <i class="fas fa-arrow-left me-2"></i> Quay lại
            </a>
            <button type="submit" class="btn btn-primary px-5 py-3 rounded-pill fw-bold shadow-lg hover-scale"
                    style="background: var(--color-lime); color: var(--color-dark); border: none; min-width: 200px;">
                Hoàn Tất Đặt Dịch Vụ <i class="fas fa-check-circle ms-2"></i>
            </button>
        </div>
    </form>
</div>

<style>
    .text-lime { color: var(--color-lime) !important; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .border-lime { border-color: var(--color-lime) !important; }
    .bg-lime { background-color: var(--color-lime) !important; }
    .background-blur-dark { background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
    
    /* Remove input number arrows */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; 
        margin: 0; 
    }
</style>

@section Scripts {
    <script>
        function adjustQty(index, delta) {
            if (!window.isLoggedIn) {
                $('#welcomeModal').modal('show');
                return;
            }

            var input = document.getElementById('qty-' + index);
            // Indicator cho Product là Overlay -> KHÔNG DÙNG Overlay cho Product
            // Chỉ dùng Border
            var maxVal = parseInt(input.getAttribute('max')) || 9999;
            var currentVal = parseInt(input.value) || 0;
            var newVal = currentVal + delta;
            
            if (newVal < 0) newVal = 0;
            if (newVal > maxVal) newVal = maxVal;
            
            input.value = newVal;

            if (newVal > 0) {
                input.closest('.card').style.border = '2px solid var(--color-lime)';
                input.closest('.card').classList.add('shadow-lg');
            } else {
                input.closest('.card').style.border = 'none';
                input.closest('.card').classList.remove('shadow-lg');
            }
        }

        function toggleHLV(index) {
            if (!window.isLoggedIn) {
                $('#welcomeModal').modal('show');
                return;
            }

            var input = document.getElementById('qty-' + index);
            var btn = document.getElementById('btn-hlv-' + index);
            var indicator = document.getElementById('indicator-' + index);
            var currentVal = parseInt(input.value) || 0;

            if (currentVal === 0) {
                // Select -> Show Overlay & Change Button Color
                input.value = 1;
                btn.innerHTML = '<i class="fas fa-check me-1"></i> Đã chọn';
                
                // Change Button Style to Match Price Badge (LIME GREEN like price badge)
                btn.style.background = 'var(--color-lime)';
                btn.style.color = 'var(--color-dark)';
                btn.style.border = 'none';

                indicator.style.display = 'flex'; 
                indicator.classList.add('d-flex'); 
                input.closest('.card').style.border = '2px solid var(--color-lime)';
                input.closest('.card').classList.add('shadow-lg');
            } else {
                // Deselect -> Hide Overlay & ROI Button Style
                input.value = 0;
                btn.innerHTML = 'Chọn HLV';
                
                // Revert Button Style (Back to Dark)
                btn.style.background = 'var(--color-dark)';
                btn.style.color = 'white';
                btn.style.border = 'none';
                
                indicator.style.display = 'none';
                indicator.classList.remove('d-flex');
                input.closest('.card').style.border = 'none';
                input.closest('.card').classList.remove('shadow-lg');
            }
        }

        // Filter Logic (Dropdown + Sort)
        document.addEventListener('DOMContentLoaded', function() {
            const btnFilter = document.getElementById('btn-apply-filter');
            const selectCategory = document.getElementById('filter-category');
            const selectSort = document.getElementById('filter-sort');
            const grid = document.getElementById('service-grid');
            const items = Array.from(document.querySelectorAll('.service-item'));

            btnFilter.addEventListener('click', () => {
                const categoryValue = selectCategory.value;
                const sortValue = selectSort.value;

                // 1. Filter Display
                items.forEach(item => {
                    const itemCategory = item.getAttribute('data-category');
                    if (categoryValue === 'all' || itemCategory === categoryValue) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });

                // 2. Sort Logic
                // Get visible items to sort (or sort all and then hide)
                // Better to sort all elements in DOM
                const sortedItems = items.sort((a, b) => {
                    // Extract price. Format "10.000 đ" -> 10000
                    const getPrice = (el) => {
                        const priceElement = el.querySelector('.position-absolute.top-0.end-0');
                        if (!priceElement) return 0;
                        const priceText = priceElement.innerText; 
                        // Clean defaults
                        return parseInt(priceText.replace(/\D/g, '')) || 0;
                    };

                    const priceA = getPrice(a);
                    const priceB = getPrice(b);

                    if (sortValue === 'price-asc') return priceA - priceB;
                    if (sortValue === 'price-desc') return priceB - priceA;
                    return 0; // default order (by index likely)
                });

                // Re-append sorted items to grid
                sortedItems.forEach(item => grid.appendChild(item));

                // Re-trigger animation for visible items
                items.filter(i => i.style.display !== 'none').forEach(item => {
                     item.style.animation = 'none';
                     item.offsetHeight; 
                     item.style.animation = 'fadeInUp 0.5s ease forwards';
                });
            });
        });
    </script>
}
