@{
    ViewData["Title"] = "ƒê·∫∑t S√¢n Tr·ª±c Ti·∫øp";
}

<style>
    /* CSS Variables */
    :root {
        --color-lime: #cce830;
        --color-lime-hover: #b5d122;
        --color-dark: #1a1a1a;
        --color-light: #f8f9fa;
    }

    /* Hero Banner */
    .hero-banner-custom {
        background: url('https://images.unsplash.com/photo-1461896836934-ffe607ba8211?q=80&w=1920&auto=format&fit=crop') center/cover no-repeat;
        color: white;
        padding: 60px 20px;
        border-radius: 0;
        margin-bottom: 30px;
        text-align: center;
        position: relative;
        overflow: hidden;
        margin-top: 85px;
        height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .hero-banner-custom::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(29, 78, 36, 0.85) 0%, rgba(76, 175, 80, 0.75) 50%, rgba(163, 207, 6, 0.65) 100%);
        z-index: 1;
    }

    .hero-banner-custom > * {
        position: relative;
        z-index: 2;
    }

    .hero-banner-custom h1 {
        font-size: 3rem;
        font-weight: 700;
        margin-bottom: 16px;
        text-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .hero-banner-custom p {
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .hero-banner-custom .highlight {
        color: var(--color-lime);
        text-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }

    /* Card Styling */
    .card-custom {
        border: none;
        border-radius: 20px;
        background: #ffffff;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 5px solid var(--color-lime);
    }

    .card-custom:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    .card-header-custom {
        background: linear-gradient(135deg, var(--color-lime) 0%, #b5d122 100%);
        color: var(--color-dark);
        border-radius: 20px 20px 0 0;
        padding: 20px 24px;
        border: none;
    }

    .card-header-custom h5 {
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Form Styling */
    .form-label-custom {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .form-control-custom, .form-select-custom {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 10px 16px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-control-custom:focus, .form-select-custom:focus {
        border-color: var(--color-lime);
        box-shadow: 0 0 0 0.2rem rgba(204, 232, 48, 0.15);
    }

    /* Button Styling */
    .btn-custom-primary {
        background: linear-gradient(135deg, var(--color-lime) 0%, #b5d122 100%);
        color: var(--color-dark);
        border: none;
        font-weight: 600;
        padding: 12px 30px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .btn-custom-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(204, 232, 48, 0.3);
    }

    .btn-custom-secondary {
        border: 2px solid #e9ecef;
        color: #6c757d;
        background: transparent;
        font-weight: 600;
        padding: 10px 24px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .btn-custom-secondary:hover {
        border-color: var(--color-lime);
        color: var(--color-lime);
        background: rgba(204, 232, 48, 0.05);
    }

    /* Tab Styling */
    .nav-tabs-custom {
        border: none;
        border-bottom: 2px solid #e9ecef;
        gap: 1rem;
    }

    .nav-link-custom {
        color: #6c757d !important;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        font-weight: 600;
        padding: 12px 24px;
        transition: all 0.3s ease;
    }

    .nav-link-custom:hover, .nav-link-custom.active {
        color: var(--color-lime) !important;
        border-bottom-color: var(--color-lime);
    }

    .nav-link-custom .icon-badge {
        display: inline-block;
        background: var(--color-lime);
        color: var(--color-dark);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        text-align: center;
        line-height: 24px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 8px;
    }

    /* Table Styling */
    .table-custom thead {
        background: #f8f9fa;
    }

    .table-custom thead th {
        border: none;
        border-bottom: 2px solid #e9ecef;
        color: #333;
        font-weight: 600;
        padding: 16px;
    }

    .table-custom tbody tr:hover {
        background: #f8f9fa;
    }

    .table-custom tbody td {
        border: none;
        border-bottom: 1px solid #e9ecef;
        padding: 14px 16px;
    }

    .badge-status {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    .badge-danger {
        background: #f8d7da;
        color: #721c24;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes fadeInTab {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .tab-pane {
        animation: fadeInTab 0.4s ease-in;
    }

    /* Toast Notification */
    .toast-container {
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 9999;
    }

    .toast-notification {
        min-width: 300px;
        max-width: 400px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        margin-bottom: 15px;
        animation: slideInRight 0.3s ease-out;
        overflow: hidden;
    }

    .toast-notification.success {
        border-left: 5px solid #28a745;
    }

    .toast-notification.error {
        border-left: 5px solid #dc3545;
    }

    .toast-notification.warning {
        border-left: 5px solid #ffc107;
    }

    .toast-notification.info {
        border-left: 5px solid #17a2b8;
    }

    .toast-header-custom {
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #f0f0f0;
    }

    .toast-body-custom {
        padding: 12px 16px;
        font-size: 14px;
        color: #333;
    }

    .toast-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
    }

    @@keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }

    .toast-notification.hiding {
        animation: slideOutRight 0.3s ease-in forwards;
    }
</style>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Hero Banner -->
<div class="hero-banner-custom container-fluid">
    <h1>
        <i class="fas fa-ticket-alt me-3"></i>ƒê·∫∂T S√ÇN & D·ªäCH V·ª§ <span class="highlight">TR·ª∞C TI·∫æP</span>
    </h1>
    <p class="lead text-light fs-5 opacity-90" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);">
            Qu·∫£n l√Ω l·ªãch ca tr·ª±c v√† ngh·ªâ ph√©p c·ªßa b·∫°n
        </p>
</div>

<div class="container-fluid px-4 py-4">
    <!-- Tabs Navigation -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card-custom">
                <ul class="nav nav-tabs-custom" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link-custom active" id="tab-booking" data-bs-toggle="tab" href="#content-booking">
                            <span class="icon-badge">1</span>
                            <i class="fas fa-calendar-check me-2"></i>ƒê·∫∑t S√¢n
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link-custom" id="tab-service" data-bs-toggle="tab" href="#content-service">
                            <span class="icon-badge">2</span>
                            <i class="fas fa-concierge-bell me-2"></i>ƒê·∫∑t D·ªãch V·ª•
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="tab-content">
        <!-- Tab 1: Booking -->
        <div id="content-booking" class="tab-pane fade show active">
            <div class="row">
                <!-- Search Customer -->
                <div class="col-lg-4">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <h5><i class="fas fa-search"></i>T√¨m Kh√°ch H√†ng</h5>
                        </div>
                        <div class="card-body p-4">
                            <label class="form-label-custom">T√¨m theo t√™n, SDT ho·∫∑c CCCD</label>
                            <input type="text" class="form-control-custom w-100 mb-3" id="searchInput" placeholder="Nh·∫≠p th√¥ng tin">
                            <div id="searchResults" class="search-results" style="display: none;">
                                <div class="list-group" id="customerList"></div>
                            </div>
                            <button type="button" class="btn btn-custom-primary w-100 mt-3" onclick="toggleNewCustomer()">
                                <i class="fas fa-user-plus me-2"></i>T·∫°o Kh√°ch M·ªõi
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Booking Form -->
                <div class="col-lg-8">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <h5><i class="fas fa-calendar"></i>Th√¥ng Tin ƒê·∫∑t S√¢n</h5>
                        </div>
                        <div class="card-body p-4">
                            <form id="bookingForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label-custom">Kh√°ch H√†ng <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control-custom w-100" id="customerInfo" placeholder="Ch·ªçn kh√°ch h√†ng" readonly>
                                            <input type="hidden" id="maKH">
                                            <button type="button" class="btn btn-outline-danger" onclick="clearCustomer()"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label-custom">C∆° S·ªü <span class="text-danger">*</span></label>
                                        <select class="form-select-custom w-100" id="maCS" onchange="loadLoaiSanByCs()">
                                            <option value="">Ch·ªçn c∆° s·ªü</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label-custom">Lo·∫°i S√¢n <span class="text-danger">*</span></label>
                                        <select class="form-select-custom w-100" id="maLoaiSan" onchange="loadCourts()">
                                            <option value="">Ch·ªçn lo·∫°i s√¢n</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label-custom">S√¢n <span class="text-danger">*</span></label>
                                        <select class="form-select-custom w-100" id="maSan">
                                            <option value="">Ch·ªçn s√¢n</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label-custom">Ng√†y ƒê·∫∑t <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control-custom w-100" id="ngayDat">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label-custom">T·ª´ Gi·ªù <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control-custom w-100" id="gioBatDau">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label-custom">ƒê·∫øn Gi·ªù <span class="text-danger">*</span></label>
                                        <input type="time" class="form-control-custom w-100" id="gioKetThuc">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label-custom">Ghi Ch√∫</label>
                                        <textarea class="form-control-custom w-100" id="ghiChu" rows="2" placeholder="Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)"></textarea>
                                    </div>
                                </div>

                                <hr>
                                <button type="button" class="btn btn-custom-primary" onclick="submitBooking()">
                                    <i class="fas fa-save me-2"></i>T·∫°o Phi·∫øu ƒê·∫∑t S√¢n
                                </button>
                                <button type="reset" class="btn btn-custom-secondary ms-2">
                                    <i class="fas fa-redo me-2"></i>L√†m M·ªõi
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Bookings -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <h5><i class="fas fa-history"></i>Phi·∫øu ƒê·∫∑t G·∫ßn ƒê√¢y</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-custom">
                                    <thead>
                                        <tr>
                                            <th>M√£ Phi·∫øu</th>
                                            <th>Kh√°ch H√†ng</th>
                                            <th>S√¢n</th>
                                            <th>Ng√†y</th>
                                            <th>Khung Gi·ªù</th>
                                            <th>Tr·∫°ng Th√°i</th>
                                            <th>Thao T√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingTable">
                                        <tr><td colspan="7" class="text-center text-muted py-4"><i class="fas fa-inbox me-2"></i>Ch∆∞a c√≥ phi·∫øu ƒë·∫∑t</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Services -->
        <div id="content-service" class="tab-pane fade">
            <div class="row">
                <!-- Service Search -->
                <div class="col-lg-4">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <h5><i class="fas fa-search"></i>T√¨m Kh√°ch H√†ng</h5>
                        </div>
                        <div class="card-body p-4">
                            <label class="form-label-custom">T√¨m theo t√™n, SDT ho·∫∑c CCCD</label>
                            <input type="text" class="form-control-custom w-100 mb-3" id="searchInputService" placeholder="Nh·∫≠p th√¥ng tin">
                            <div id="searchResultsService" class="search-results" style="display: none;">
                                <div class="list-group" id="customerListService"></div>
                            </div>
                            <button type="button" class="btn btn-custom-primary w-100 mt-3" onclick="toggleNewCustomerService()">
                                <i class="fas fa-user-plus me-2"></i>T·∫°o Kh√°ch M·ªõi
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Service Form -->
                <div class="col-lg-8">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <h5><i class="fas fa-concierge-bell"></i>Th√¥ng Tin ƒê·∫∑t D·ªãch V·ª•</h5>
                        </div>
                        <div class="card-body p-4">
                            <form id="serviceForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label-custom">Kh√°ch H√†ng <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control-custom w-100" id="customerInfoService" placeholder="Ch·ªçn kh√°ch h√†ng" readonly>
                                            <input type="hidden" id="maKHService">
                                            <button type="button" class="btn btn-outline-danger" onclick="clearCustomerService()"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label-custom">D·ªãch V·ª• <span class="text-danger">*</span></label>
                                        <select class="form-select-custom w-100" id="maDichVu" onchange="loadServiceDetails()">
                                            <option value="">Ch·ªçn d·ªãch v·ª•</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label-custom">S·ªë L∆∞·ª£ng <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control-custom w-100" id="soLuongDichVu" min="1" value="1">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label-custom">Gi√° (ƒë)</label>
                                        <input type="text" class="form-control-custom w-100" id="giaDichVu" readonly placeholder="Gi√° s·∫Ω hi·ªÉn th·ªã">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label-custom">Ghi Ch√∫</label>
                                        <textarea class="form-control-custom w-100" id="ghiChuDichVu" rows="2" placeholder="Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)"></textarea>
                                    </div>
                                </div>

                                <hr>
                                <button type="button" class="btn btn-custom-primary" onclick="submitService()">
                                    <i class="fas fa-save me-2"></i>T·∫°o Phi·∫øu D·ªãch V·ª•
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="skipService()">
                                    <i class="fas fa-forward me-2"></i>B·ªè Qua D·ªãch V·ª•
                                </button>
                                <button type="reset" class="btn btn-custom-secondary ms-2">
                                    <i class="fas fa-redo me-2"></i>L√†m M·ªõi
                                </button>
                                
                                <hr class="mt-4">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success flex-fill" onclick="printConfirmation()">
                                        <i class="fas fa-print me-2"></i>In Phi·∫øu X√°c Nh·∫≠n
                                    </button>
                                    <button type="button" class="btn btn-warning flex-fill" onclick="sendToCashier()">
                                        <i class="fas fa-cash-register me-2"></i>Chuy·ªÉn Cho Thu Ng√¢n Thanh To√°n
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Services -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card-custom">
                        <div class="card-header-custom">
                            <h5><i class="fas fa-history"></i>Phi·∫øu D·ªãch V·ª• G·∫ßn ƒê√¢y</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="table-responsive">
                                <table class="table table-custom">
                                    <thead>
                                        <tr>
                                            <th>M√£ Phi·∫øu</th>
                                            <th>Kh√°ch H√†ng</th>
                                            <th>D·ªãch V·ª•</th>
                                            <th>SL</th>
                                            <th>Gi√°</th>
                                            <th>Tr·∫°ng Th√°i</th>
                                            <th>Thao T√°c</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serviceTable">
                                        <tr><td colspan="7" class="text-center text-muted py-4"><i class="fas fa-inbox me-2"></i>Ch∆∞a c√≥ phi·∫øu d·ªãch v·ª•</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Customer Modal -->
<div class="modal fade" id="createCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--color-lime) 0%, #b5d122 100%); border: none;">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>T·∫°o Kh√°ch H√†ng M·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="createCustomerForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label-custom">H·ªç T√™n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control-custom w-100" id="newCustomerHoTen" placeholder="Nh·∫≠p h·ªç t√™n">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">SDT <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control-custom w-100" id="newCustomerSDT" placeholder="Nh·∫≠p SDT">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label-custom">CCCD</label>
                            <input type="text" class="form-control-custom w-100" id="newCustomerCCCD" placeholder="Nh·∫≠p CCCD">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">Email</label>
                            <input type="email" class="form-control-custom w-100" id="newCustomerEmail" placeholder="Nh·∫≠p email">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label-custom">ƒê·ªãa Ch·ªâ</label>
                            <textarea class="form-control-custom w-100" id="newCustomerDiaChi" rows="2" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-custom-primary" id="createCustomerBtn"><i class="fas fa-check me-2"></i>T·∫°o</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded fired - Starting initialization');
        
        // Set today's date in both tabs
        if (document.getElementById('ngayDat')) {
            document.getElementById('ngayDat').valueAsDate = new Date();
            console.log('Date set for booking form');
        } else {
            console.warn('Element ngayDat not found');
        }
        
        // Check if dropdown elements exist
        console.log('Checking dropdown elements:');
        console.log('- maCS element:', document.getElementById('maCS') ? 'EXISTS' : 'NOT FOUND');
        console.log('- maLoaiSan element:', document.getElementById('maLoaiSan') ? 'EXISTS' : 'NOT FOUND');
        console.log('- maSan element:', document.getElementById('maSan') ? 'EXISTS' : 'NOT FOUND');
        console.log('- maDichVu element:', document.getElementById('maDichVu') ? 'EXISTS' : 'NOT FOUND');
        
        // Load all dropdowns immediately (no setTimeout)
        console.log('Starting to load dropdowns...');
        loadCoSo();
        loadDichVu();
        loadPhieuDatGanDay();
        loadPhieuDichVuGanDay();

        // Create customer button
        if (document.getElementById('createCustomerBtn')) {
            document.getElementById('createCustomerBtn').addEventListener('click', createNewCustomer);
        }
    });

    // LOAD DROPDOWNS
    function loadCoSo() {
        console.log('loadCoSo() called - fetching facilities...');
        fetch('@Url.Action("LoadCoSo", "DatSanTrucTiep")')
            .then(r => {
                console.log('LoadCoSo response status:', r.status, r.statusText);
                return r.json();
            })
            .then(d => {
                console.log('LoadCoSo result:', d);
                console.log('LoadCoSo d.success:', d.success);
                console.log('LoadCoSo d.data:', d.data);
                console.log('LoadCoSo d.data type:', typeof d.data);
                console.log('LoadCoSo d.data length:', d.data ? d.data.length : 'undefined');
                
                if (d.success && d.data) {
                    console.log('LoadCoSo data count:', d.data.length);
                    let html = '<option value="">Ch·ªçn c∆° s·ªü</option>';
                    d.data.forEach(i => {
                        console.log('Adding facility:', i);
                        html += `<option value="${i.MaCS || i.maCS}">${i.TenCS || i.tenCS}</option>`;
                    });
                    const el = document.getElementById('maCS');
                    if (el) {
                        el.innerHTML = html;
                        console.log('‚úÖ LoadCoSo dropdown populated successfully with', d.data.length, 'items');
                    } else {
                        console.error('‚ùå Element #maCS not found in DOM!');
                    }
                } else {
                    console.error('‚ùå LoadCoSo failed or no data:', d);
                    console.error('   - success:', d.success);
                    console.error('   - data:', d.data);
                }
            })
            .catch(err => {
                console.error('‚ùå LoadCoSo error:', err);
                console.error('Error details:', err.message, err.stack);
            });
    }

    function loadLoaiSanByCs() {
        const maCS = document.getElementById('maCS').value;
        if (!maCS) return;
        fetch('@Url.Action("LoadLoaiSan", "DatSanTrucTiep")')
            .then(r => r.json())
            .then(d => {
                console.log('LoadLoaiSan result:', d);
                if (d.success && d.data) {
                    let html = '<option value="">Ch·ªçn lo·∫°i s√¢n</option>';
                    d.data.forEach(i => html += `<option value="${i.MaLS || i.maLS}">${i.TenLS || i.tenLS}</option>`);
                    const el = document.getElementById('maLoaiSan');
                    if (el) el.innerHTML = html;
                }
            })
            .catch(err => console.error('LoadLoaiSan error:', err));
    }

    function loadCourts() {
        const maCS = document.getElementById('maCS').value;
        const maLS = document.getElementById('maLoaiSan').value;
        if (!maCS || !maLS) return;
        fetch('@Url.Action("LoadSan", "DatSanTrucTiep")', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({maCS, maLS})
        })
        .then(r => r.json())
        .then(d => {
            console.log('LoadSan result:', d);
            if (d.success && d.data) {
                let html = '<option value="">Ch·ªçn s√¢n</option>';
                d.data.forEach(i => {
                    const sucChua = i.SucChua || i.sucChua || 0;
                    html += `<option value="${i.MaSan || i.maSan}">${i.TenSan || i.tenSan} (Ch·ª©a ${sucChua} ng∆∞·ªùi)</option>`;
                });
                const el = document.getElementById('maSan');
                if (el) el.innerHTML = html;
            }
        })
        .catch(err => console.error('LoadSan error:', err));
    }

    function loadDichVu() {
        fetch('@Url.Action("LoadDichVu", "DatSanTrucTiep")')
            .then(r => r.json())
            .then(d => {
                console.log('LoadDichVu result:', d);
                if (d.success && d.data) {
                    let html = '<option value="">Ch·ªçn d·ªãch v·ª•</option>';
                    d.data.forEach(i => html += `<option value="${i.MaDV || i.maDV}" data-gia="${i.Gia || i.gia}" data-soluong="${i.SoLuongTon || i.soLuongTon}" data-dvt="${i.DVT || i.dvt}">${i.TenDV || i.tenDV} (${i.Gia || i.gia}ƒë/${i.DVT || i.dvt})</option>`);
                    const el = document.getElementById('maDichVu');
                    if (el) el.innerHTML = html;
                }
            })
            .catch(err => console.error('LoadDichVu error:', err));
    }

    function loadPhieuDatGanDay() {
        console.log('üîç Loading phi·∫øu ƒë·∫∑t g·∫ßn ƒë√¢y...');
        fetch('@Url.Action("LoadPhieuDatGanDay", "DatSanTrucTiep")')
            .then(r => {
                console.log('üì• Response status:', r.status);
                return r.json();
            })
            .then(d => {
                console.log('‚úÖ LoadPhieuDatGanDay result:', d);
                console.log('üìä Data:', JSON.stringify(d, null, 2));
                
                if (d.success && d.data && d.data.length > 0) {
                    console.log('üìã Found', d.data.length, 'bookings');
                    console.log('üîé First booking:', d.data[0]);
                    
                    let html = '';
                    d.data.forEach(item => {
                        console.log('Processing item:', item);
                        let cls = item.trangThai === 'ƒê√£ ƒë·∫∑t' ? 'badge-success' : (item.trangThai === 'ƒêang s·ª≠ d·ª•ng' ? 'badge-warning' : 'badge-danger');
                        // USE CAMELCASE: maDatSan, tenKH, danhSachSan, ngayDat, gioBatDau, gioKetThuc, trangThai
                        html += `<tr><td><strong>${item.maDatSan}</strong></td><td>${item.tenKH}</td><td>${item.danhSachSan}</td><td>${item.ngayDat}</td><td>${item.gioBatDau} - ${item.gioKetThuc}</td><td><span class="badge-status ${cls}">${item.trangThai}</span></td><td><button class="btn btn-sm btn-outline-primary">Chi ti·∫øt</button></td></tr>`;
                    });
                    document.getElementById('bookingTable').innerHTML = html;
                    console.log('‚úÖ Table updated successfully');
                } else {
                    console.log('‚ö†Ô∏è No data or empty array');
                    document.getElementById('bookingTable').innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ phi·∫øu ƒë·∫∑t n√†o</td></tr>';
                }
            })
            .catch(err => {
                console.error('‚ùå LoadPhieuDatGanDay error:', err);
                document.getElementById('bookingTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
            });
    }

    function loadPhieuDichVuGanDay() {
        console.log('üîç Loading phi·∫øu d·ªãch v·ª• g·∫ßn ƒë√¢y...');
        fetch('@Url.Action("LoadPhieuDichVuGanDay", "DatSanTrucTiep")')
            .then(r => {
                console.log('üì• Service response status:', r.status);
                return r.json();
            })
            .then(d => {
                console.log('‚úÖ LoadPhieuDichVuGanDay result:', d);
                
                if (d.success && d.data && d.data.length > 0) {
                    console.log('üìã Found', d.data.length, 'service orders');
                    let html = '';
                    d.data.forEach(item => {
                        let cls = item.trangThai === 'ƒê√£ thanh to√°n' ? 'badge-success' : (item.trangThai === 'Ch·ªù thanh to√°n' ? 'badge-warning' : 'badge-danger');
                        // USE CAMELCASE: maDatDichVu, tenKhachHang, tenDichVu, soLuong, tongTien, trangThai
                        html += `<tr><td><strong>${item.maDatDichVu}</strong></td><td>${item.tenKhachHang}</td><td>${item.tenDichVu}</td><td>${item.soLuong}</td><td>${item.tongTien}ƒë</td><td><span class="badge-status ${cls}">${item.trangThai}</span></td><td><button class="btn btn-sm btn-outline-primary">Chi ti·∫øt</button></td></tr>`;
                    });
                    document.getElementById('serviceTable').innerHTML = html;
                    console.log('‚úÖ Service table updated successfully');
                } else {
                    console.log('‚ö†Ô∏è No service data');
                    document.getElementById('serviceTable').innerHTML = '<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ phi·∫øu d·ªãch v·ª• n√†o</td></tr>';
                }
            })
            .catch(err => {
                console.error('‚ùå LoadPhieuDichVuGanDay error:', err);
                document.getElementById('serviceTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
            });
    }

    // CUSTOMER SEARCH
    let searchTimeout;
    if (document.getElementById('searchInput')) {
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const keyword = e.target.value.trim();
            if (keyword.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            searchTimeout = setTimeout(() => {
                const url = new URL('@Url.Action("TimKhachHang", "DatSanTrucTiep")', window.location.origin);
                url.searchParams.append('tuKhoa', keyword);
                
                fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'}
                })
                .then(r => r.json())
                .then(d => {
                    console.log('Search result:', d);
                    if (d.success && d.data && d.data.length > 0) {
                        let html = '';
                        d.data.forEach(c => {
                            // support different casing from backend (MaKH / maKH, HoTen / hoTen, SDT / sdt)
                            const maKH = c.MaKH || c.maKH || '';
                            const hoTen = c.HoTen || c.hoTen || 'Kh√¥ng r√µ';
                            const sdt = c.SDT || c.sdt || 'Ch∆∞a c√≥';
                            const cccd = c.CCCD || c.cccd || '';
                            html += `<button type="button" class="list-group-item list-group-item-action" onclick="selectCustomer('${maKH}', '${hoTen}', '${sdt}')"><strong>${hoTen}</strong><br><small class="text-muted">${sdt}${cccd ? ' | ' + cccd : ''}</small></button>`;
                        });
                        document.getElementById('customerList').innerHTML = html;
                        document.getElementById('searchResults').style.display = 'block';
                    } else {
                        document.getElementById('customerList').innerHTML = '<div class="alert alert-info mb-0">Kh√¥ng t√¨m th·∫•y</div>';
                        document.getElementById('searchResults').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Search error:', err);
                    document.getElementById('customerList').innerHTML = '<div class="alert alert-danger mb-0">L·ªói t√¨m ki·∫øm</div>';
                });
            }, 300);
        });
    }

    function selectCustomer(maKH, hoTen, sdt) {
        document.getElementById('maKH').value = maKH;
        document.getElementById('customerInfo').value = hoTen + ' (' + sdt + ')';
        document.getElementById('searchResults').style.display = 'none';
        document.getElementById('searchInput').value = '';
    }

    function clearCustomer() {
        document.getElementById('maKH').value = '';
        document.getElementById('customerInfo').value = '';
    }

    function toggleNewCustomer() {
        new bootstrap.Modal(document.getElementById('createCustomerModal')).show();
    }

    function createNewCustomer() {
        const hoTen = document.getElementById('newCustomerHoTen').value;
        const sdt = document.getElementById('newCustomerSDT').value;
        if (!hoTen || !sdt) {
            showNotification('Vui l√≤ng nh·∫≠p h·ªç t√™n v√† SDT!', 'warning');
            return;
        }
        fetch('@Url.Action("TaoKhachHang", "DatSanTrucTiep")', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                hoTen,
                sdt,
                cccd: document.getElementById('newCustomerCCCD').value,
                email: document.getElementById('newCustomerEmail').value,
                diaChi: document.getElementById('newCustomerDiaChi').value
            })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message || 'T·∫°o kh√°ch h√†ng m·ªõi th√†nh c√¥ng!', 'success');
                const maKH = d.maKH || d.MaKH || '';
                const hoTen = d.hoTen || d.hoTen || d.hoTen || '';
                const sdt = d.sdt || d.SDT || '';
                selectCustomer(maKH, hoTen || d.hoTen || d.HoTen || '', sdt);
                document.getElementById('createCustomerForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('createCustomerModal')).hide();
            } else {
                showNotification(d.message || 'L·ªói khi t·∫°o kh√°ch h√†ng', 'error');
            }
        })
        .catch(err => {
            showNotification('L·ªói k·∫øt n·ªëi: ' + err.message, 'error');
        });
    }

    // NOTIFICATION SYSTEM
    function showNotification(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        
        const titles = {
            success: 'Th√†nh c√¥ng',
            error: 'L·ªói',
            warning: 'C·∫£nh b√°o',
            info: 'Th√¥ng b√°o'
        };
        
        toast.innerHTML = `
            <div class="toast-header-custom">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${icons[type]}" style="font-size: 18px;"></i>
                    <strong>${titles[type]}</strong>
                </div>
                <button class="toast-close" onclick="this.closest('.toast-notification').remove()">√ó</button>
            </div>
            <div class="toast-body-custom">${message}</div>
        `;
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('hiding');
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    // BOOKING FUNCTIONS
    function submitBooking() {
        const maKH = document.getElementById('maKH').value.trim();
        const maCS = document.getElementById('maCS').value;
        const maLoaiSan = document.getElementById('maLoaiSan').value;
        const maSan = document.getElementById('maSan').value;
        const ngayDat = document.getElementById('ngayDat').value;
        const gioBatDau = document.getElementById('gioBatDau').value;
        const gioKetThuc = document.getElementById('gioKetThuc').value;
        
        // DEBUG: Hi·ªÉn th·ªã gi√° tr·ªã c·ªßa t·∫•t c·∫£ field
        console.log('submitBooking - Values:', {
            maKH: maKH || 'EMPTY',
            maCS: maCS || 'EMPTY',
            maLoaiSan: maLoaiSan || 'EMPTY',
            maSan: maSan || 'EMPTY',
            ngayDat: ngayDat || 'EMPTY',
            gioBatDau: gioBatDau || 'EMPTY',
            gioKetThuc: gioKetThuc || 'EMPTY'
        });
        
        // Validation t·ª´ng tr∆∞·ªùng r√µ r√†ng
        if (!maKH || maKH === '') {
            showNotification('Vui l√≤ng ch·ªçn kh√°ch h√†ng!', 'warning');
            document.getElementById('searchInput').focus();
            return;
        }
        if (!maCS || maCS === '') {
            showNotification('Vui l√≤ng ch·ªçn c∆° s·ªü!', 'warning');
            document.getElementById('maCS').focus();
            return;
        }
        if (!maLoaiSan || maLoaiSan === '') {
            showNotification('Vui l√≤ng ch·ªçn lo·∫°i s√¢n!', 'warning');
            document.getElementById('maLoaiSan').focus();
            return;
        }
        if (!maSan || maSan === '') {
            showNotification('Vui l√≤ng ch·ªçn s√¢n!', 'warning');
            document.getElementById('maSan').focus();
            return;
        }
        if (!ngayDat) {
            showNotification('Vui l√≤ng ch·ªçn ng√†y ƒë·∫∑t!', 'warning');
            document.getElementById('ngayDat').focus();
            return;
        }
        if (!gioBatDau) {
            showNotification('Vui l√≤ng ch·ªçn gi·ªù b·∫Øt ƒë·∫ßu!', 'warning');
            document.getElementById('gioBatDau').focus();
            return;
        }
        if (!gioKetThuc) {
            showNotification('Vui l√≤ng ch·ªçn gi·ªù k·∫øt th√∫c!', 'warning');
            document.getElementById('gioKetThuc').focus();
            return;
        }

        // VALIDATION: Ki·ªÉm tra th·ªùi l∆∞·ª£ng theo lo·∫°i s√¢n
        const loaiSanSelect = document.getElementById('maLoaiSan');
        const loaiSanText = loaiSanSelect.options[loaiSanSelect.selectedIndex]?.text || '';
        const loaiSanLower = loaiSanText.toLowerCase();
        
        const startTime = new Date(`${ngayDat}T${gioBatDau}`);
        const endTime = new Date(`${ngayDat}T${gioKetThuc}`);
        const durationMinutes = (endTime - startTime) / (1000 * 60);
        
        if (durationMinutes <= 0) {
            showNotification('Gi·ªù k·∫øt th√∫c ph·∫£i sau gi·ªù b·∫Øt ƒë·∫ßu!', 'error');
            return;
        }
        
        // Ki·ªÉm tra b·ªôi s·ªë theo lo·∫°i s√¢n
        if (loaiSanLower.includes('b√≥ng ƒë√°') || loaiSanLower.includes('futsal')) {
            if (durationMinutes % 90 !== 0 || durationMinutes < 90) {
                showNotification(`S√¢n b√≥ng ƒë√° mini ph·∫£i ƒë·∫∑t theo b·ªôi s·ªë 90 ph√∫t (1 tr·∫≠n = 90p)!<br>Th·ªùi l∆∞·ª£ng hi·ªán t·∫°i: ${durationMinutes} ph√∫t.`, 'error');
                return;
            }
        } else if (loaiSanLower.includes('tennis')) {
            if (durationMinutes % 120 !== 0 || durationMinutes < 120) {
                showNotification(`S√¢n Tennis ph·∫£i ƒë·∫∑t theo ca 2 gi·ªù (120 ph√∫t)!<br>Th·ªùi l∆∞·ª£ng hi·ªán t·∫°i: ${durationMinutes} ph√∫t.`, 'error');
                return;
            }
        } else if (loaiSanLower.includes('c·∫ßu l√¥ng') || loaiSanLower.includes('b√≥ng r·ªï')) {
            if (durationMinutes % 60 !== 0 || durationMinutes < 60) {
                showNotification(`S√¢n ${loaiSanText} ph·∫£i ƒë·∫∑t theo b·ªôi s·ªë 1 gi·ªù (60 ph√∫t)!<br>Th·ªùi l∆∞·ª£ng hi·ªán t·∫°i: ${durationMinutes} ph√∫t.`, 'error');
                return;
            }
        }
        
        fetch('@Url.Action("TaoPhieuDat", "DatSanTrucTiep")', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({maKH, maSan, ngayDat, gioBatDau, gioKetThuc, ghiChu: document.getElementById('ghiChu').value})
        })
        .then(r => r.json())
        .then(d => {
            if (d.success && d.data) {
                showNotification(d.message || 'T·∫°o phi·∫øu ƒë·∫∑t s√¢n th√†nh c√¥ng!', 'success');
                
                // Store booking data globally
                window.currentBooking = d.data;
                
                // Auto switch to service tab
                const serviceTab = document.getElementById('tab-service');
                const bookingTab = document.getElementById('tab-booking');
                
                // Activate service tab
                serviceTab.click();
                
                // Load customer info into service form (readonly)
                document.getElementById('customerInfoService').value = `${d.data.tenKH} (${d.data.sdtKH})`;
                document.getElementById('maKHService').value = d.data.maKH;
                
                // Disable customer selection in service tab
                document.getElementById('searchInputService').disabled = true;
                
                // Load services based on facility and court type
                loadDichVuByCoSoVaLoaiSan(d.data.maCoSo, d.data.maLoaiSan);
                
                // Reset booking form
                document.getElementById('bookingForm').reset();
                clearCustomer();
                loadPhieuDatGanDay();
            } else {
                showNotification(d.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o phi·∫øu ƒë·∫∑t s√¢n', 'error');
            }
        })
        .catch(err => {
            showNotification('L·ªói k·∫øt n·ªëi: ' + err.message, 'error');
        });
    }
    
    // Load services based on facility and court type
    function loadDichVuByCoSoVaLoaiSan(maCS, maLS) {
        const url = '@Url.Action("LoadDichVu", "DatSanTrucTiep")?maCS=' + maCS + '&maLS=' + maLS;
        
        fetch(url)
        .then(r => r.json())
        .then(d => {
            const select = document.getElementById('maDichVu');
            select.innerHTML = '<option value="">Ch·ªçn d·ªãch v·ª•</option>';
            
            if (d.success && d.data) {
                d.data.forEach(dv => {
                    const option = document.createElement('option');
                    option.value = dv.MaDV || dv.maDV;
                    option.textContent = `${dv.TenDV || dv.tenDV} - ${formatCurrency(dv.Gia || dv.gia)}/${dv.DVT || dv.dvt} (C√≤n: ${dv.SoLuongTon || dv.soLuongTon})`;
                    option.dataset.gia = dv.Gia || dv.gia;
                    option.dataset.soLuongTon = dv.SoLuongTon || dv.soLuongTon;
                    select.appendChild(option);
                });
                showNotification('ƒê√£ t·∫£i danh s√°ch d·ªãch v·ª• ph√π h·ª£p!', 'info');
            } else {
                showNotification('Kh√¥ng c√≥ d·ªãch v·ª• ph√π h·ª£p!', 'warning');
            }
        })
        .catch(err => {
            showNotification('L·ªói t·∫£i d·ªãch v·ª•: ' + err.message, 'error');
        });
    }
    
    // Helper function to format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }
    
    // Load service details when selected
    function loadServiceDetails() {
        const select = document.getElementById('maDichVu');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            document.getElementById('giaDichVu').value = formatCurrency(selectedOption.dataset.gia);
        } else {
            document.getElementById('giaDichVu').value = '';
        }
    }
    
    // Submit service
    function submitService() {
        if (!window.currentBooking) {
            showNotification('Vui l√≤ng ƒë·∫∑t s√¢n tr∆∞·ªõc!', 'warning');
            return;
        }
        
        const maDV = document.getElementById('maDichVu').value;
        const soLuong = document.getElementById('soLuongDichVu').value;
        const ghiChu = document.getElementById('ghiChuDichVu').value;
        
        if (!maDV || !soLuong || soLuong <= 0) {
            showNotification('Vui l√≤ng ch·ªçn d·ªãch v·ª• v√† nh·∫≠p s·ªë l∆∞·ª£ng!', 'warning');
            return;
        }
        
        // Check stock
        const select = document.getElementById('maDichVu');
        const selectedOption = select.options[select.selectedIndex];
        const soLuongTon = parseInt(selectedOption.dataset.soLuongTon);
        
        if (parseInt(soLuong) > soLuongTon) {
            showNotification(`S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho! C√≤n l·∫°i: ${soLuongTon}`, 'error');
            return;
        }
        
        fetch('@Url.Action("TaoPhieuDichVu", "DatSanTrucTiep")', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                maDatSan: window.currentBooking.maDatSan.toString(),
                maDV,
                soLuong,
                ghiChu
            })
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message || 'Th√™m d·ªãch v·ª• th√†nh c√¥ng!', 'success');
                
                // Reset form
                document.getElementById('serviceForm').reset();
                document.getElementById('giaDichVu').value = '';
                
                // Reload services to update stock
                loadDichVuByCoSoVaLoaiSan(window.currentBooking.maCoSo, window.currentBooking.maLoaiSan);
            } else {
                showNotification(d.message || 'C√≥ l·ªói x·∫£y ra', 'error');
            }
        })
        .catch(err => {
            showNotification('L·ªói k·∫øt n·ªëi: ' + err.message, 'error');
        });
    }
    
    // Clear service customer (not allowed since it's from booking)
    function clearCustomerService() {
        showNotification('Kh√¥ng th·ªÉ x√≥a th√¥ng tin kh√°ch h√†ng t·ª´ phi·∫øu ƒë·∫∑t s√¢n!', 'warning');
    }
    
    // Skip service - proceed to confirmation
    function skipService() {
        if (!window.currentBooking) {
            showNotification('Vui l√≤ng ƒë·∫∑t s√¢n tr∆∞·ªõc!', 'warning');
            return;
        }
        
        showNotification('ƒê√£ b·ªè qua ƒë·∫∑t d·ªãch v·ª•. C√≥ th·ªÉ in phi·∫øu x√°c nh·∫≠n ho·∫∑c chuy·ªÉn cho thu ng√¢n!', 'info');
    }
    
    // Print confirmation slip
    function printConfirmation() {
        if (!window.currentBooking) {
            showNotification('Vui l√≤ng ƒë·∫∑t s√¢n tr∆∞·ªõc!', 'warning');
            return;
        }
        
        // Open print view in new window
        const printUrl = '@Url.Action("PrintConfirmation", "DatSanTrucTiep")?maDatSan=' + window.currentBooking.maDatSan;
        window.open(printUrl, '_blank', 'width=800,height=600');
        showNotification('ƒêang m·ªü c·ª≠a s·ªï in phi·∫øu...', 'info');
    }
    
    // Send to cashier for payment
    function sendToCashier() {
        if (!window.currentBooking) {
            showNotification('Vui l√≤ng ƒë·∫∑t s√¢n tr∆∞·ªõc!', 'warning');
            return;
        }
        
        if (!confirm('X√°c nh·∫≠n chuy·ªÉn phi·∫øu ƒë·∫∑t s√¢n cho thu ng√¢n thanh to√°n?')) {
            return;
        }
        
        fetch('@Url.Action("ChuyenThuNgan", "DatSanTrucTiep")', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({maDatSan: window.currentBooking.maDatSan.toString()})
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification('ƒê√£ chuy·ªÉn cho thu ng√¢n thanh to√°n th√†nh c√¥ng!', 'success');
                
                // Reset form and booking context
                window.currentBooking = null;
                document.getElementById('bookingForm').reset();
                document.getElementById('serviceForm').reset();
                clearCustomer();
                
                // Switch back to booking tab
                document.getElementById('tab-booking').click();
                
                // Enable customer search in service tab again
                document.getElementById('searchInputService').disabled = false;
                document.getElementById('customerInfoService').value = '';
                document.getElementById('maKHService').value = '';
                
                // Refresh recent bookings
                loadPhieuDatGanDay();
            } else {
                showNotification(d.message || 'C√≥ l·ªói x·∫£y ra', 'error');
            }
        })
        .catch(err => {
            showNotification('L·ªói k·∫øt n·ªëi: ' + err.message, 'error');
        });
    }

    // SERVICE FUNCTIONS
    let searchTimeoutService;
    const searchInputServiceEl = document.getElementById('searchInputService');
    if (searchInputServiceEl) {
        searchInputServiceEl.addEventListener('input', function(e) {
            clearTimeout(searchTimeoutService);
            const keyword = e.target.value.trim();
            if (keyword.length < 2) {
                document.getElementById('searchResultsService').style.display = 'none';
                return;
            }
            searchTimeoutService = setTimeout(() => {
                const url = new URL('@Url.Action("TimKhachHang", "DatSanTrucTiep")', window.location.origin);
                url.searchParams.append('tuKhoa', keyword);
                
                fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'}
                })
                .then(r => r.json())
                .then(d => {
                    console.log('Search service result:', d);
                    if (d.success && d.data && d.data.length > 0) {
                        let html = '';
                        d.data.forEach(c => {
                            const maKH = c.MaKH || c.maKH || '';
                            const hoTen = c.HoTen || c.hoTen || 'Kh√¥ng r√µ';
                            const sdt = c.SDT || c.sdt || 'Ch∆∞a c√≥';
                            const cccd = c.CCCD || c.cccd || '';
                            html += `<button type="button" class="list-group-item list-group-item-action" onclick="selectCustomerService('${maKH}', '${hoTen}', '${sdt}')"><strong>${hoTen}</strong><br><small class="text-muted">${sdt}${cccd ? ' | ' + cccd : ''}</small></button>`;
                        });
                        document.getElementById('customerListService').innerHTML = html;
                        document.getElementById('searchResultsService').style.display = 'block';
                    } else {
                        document.getElementById('customerListService').innerHTML = '<div class="alert alert-info mb-0">Kh√¥ng t√¨m th·∫•y</div>';
                        document.getElementById('searchResultsService').style.display = 'block';
                    }
                })
                .catch(err => console.error('Search service error:', err));
            }, 300);
        });
    }

    function selectCustomerService(maKH, hoTen, sdt) {
        document.getElementById('maKHService').value = maKH;
        document.getElementById('customerInfoService').value = hoTen + ' (' + sdt + ')';
        document.getElementById('searchResultsService').style.display = 'none';
        document.getElementById('searchInputService').value = '';
    }

    function clearCustomerService() {
        document.getElementById('maKHService').value = '';
        document.getElementById('customerInfoService').value = '';
    }

    function toggleNewCustomerService() {
        new bootstrap.Modal(document.getElementById('createCustomerModal')).show();
    }

    function loadServiceDetails() {
        const maDichVu = document.getElementById('maDichVu').value;
        const option = document.querySelector(`#maDichVu option[value="${maDichVu}"]`);
        if (option) {
            const gia = option.getAttribute('data-gia');
            document.getElementById('giaDichVu').value = gia + 'ƒë';
        }
    }

    function submitService() {
        const maKH = document.getElementById('maKHService').value;
        const maDichVu = document.getElementById('maDichVu').value;
        const soLuong = parseInt(document.getElementById('soLuongDichVu').value);
        if (!maKH || !maDichVu || !soLuong) {
            showNotification('Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!', 'warning');
            return;
        }
        fetch('@Url.Action("TaoPhieuDichVu", "DatSanTrucTiep")', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({maKH, maDichVu, soLuong, ghiChu: document.getElementById('ghiChuDichVu').value})
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                showNotification(d.message || 'T·∫°o phi·∫øu d·ªãch v·ª• th√†nh c√¥ng!', 'success');
                document.getElementById('serviceForm').reset();
                clearCustomerService();
                loadPhieuDichVuGanDay();
            } else {
                showNotification(d.message || 'C√≥ l·ªói x·∫£y ra khi t·∫°o phi·∫øu d·ªãch v·ª•', 'error');
            }
        })
        .catch(err => {
            showNotification('L·ªói k·∫øt n·ªëi: ' + err.message, 'error');
        });
    }
</script>
