@model webapp_mvc.Models.DatSanViewModel
@{
    ViewData["Title"] = "Đặt Sân Trực Tuyến";
}

<!-- Hero Banner -->
<div class="position-relative w-100 d-flex align-items-center justify-content-center mb-5" 
     style="height: 500px; background: url('@Url.Content("~/images/hero_bg.jpg")') center/cover no-repeat; padding-top: 85px; z-index: 1;">
    <!-- Dark Overlay -->
    <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(to right, rgba(0,0,0,0.7), rgba(0,0,0,0.4));"></div>
    
    <div class="text-center position-relative fade-in-up px-3" style="z-index: 2;">
        <h1 class="display-3 fw-bold text-white mb-3" style="text-shadow: 0 4px 10px rgba(0,0,0,0.5); letter-spacing: 1px; text-transform: uppercase;">
            ĐẶT SÂN <span style="color: var(--color-lime);">NHANH CHÓNG</span>
        </h1>
        <p class="lead text-light fs-5 opacity-90 mb-4 mx-auto" style="max-width: 800px;">
            Hệ thống đặt sân trực tuyến hiện đại, tiện lợi. <br class="d-none d-md-block">
            Kiểm tra lịch trống và giữ chỗ ngay chỉ trong vài thao tác.
        </p>
    </div>
</div>

<div class="container py-4" id="booking-filter">

    <!-- Booking Rules & Policies -->
    <div class="alert bg-white border-0 shadow-sm rounded-4 mb-5 fade-in-up" role="alert" style="border-left: 6px solid #FFC107;">
        <div class="d-flex align-items-start">
            <div class="me-4 text-warning mt-1">
                <i class="fas fa-bullhorn fa-2x"></i>
            </div>
            <div>
                <h5 class="alert-heading fw-bold mb-2 text-dark">Lưu Ý & Quy Định Đặt Sân</h5>
                <div class="row g-3 text-secondary small">
                    <div class="col-md-6">
                        <ul class="mb-0 ps-3">
                            <li class="mb-1"><strong>Giờ hoạt động:</strong> 06:00 - 22:00 hàng ngày.</li>
                            <li class="mb-1"><strong>Giới hạn:</strong> Mỗi tài khoản không quá 2 sân/ngày.</li>
                            <li><strong>Thời gian:</strong> Đặt trước ít nhất 2 giờ so với giờ bắt đầu.</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="mb-0 ps-3">
                            <li class="mb-1"><strong>Thanh toán Online:</strong> Thẻ hoặc Ví điện tử.</li>
                            <li><strong>Thanh toán tại quầy:</strong> Hoàn tất trong vòng <strong>30 phút</strong> sau khi đặt (hệ thống sẽ tự động hủy nếu quá hạn).</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Bar (Avatar Dark Lime Border Theme) -->
    <div class="card border-0 mb-5 fade-in-up" 
         style="background: #ffffff; border-radius: 20px; border: 5px solid #a3cf06; box-shadow: 0 0 20px rgba(163, 207, 6, 0.2);">
        <div class="card-body p-3 px-md-4">
            <form method="get" asp-action="Index" class="row g-2 align-items-end">
                <!-- Cơ sở -->
                <div class="col-md-2">
                    <label class="form-label text-dark fw-bold ms-1" style="font-size: 0.75rem;"><i class="fas fa-map-marker-alt me-1 text-warning"></i>CƠ SỞ</label>
                    <select name="maCS" class="form-select py-2 text-dark fw-bold shadow-sm" style="border-radius: 10px; background: #ffffff; border: 2px solid #e9ecef; font-size: 0.85rem;">
                        <option value="">-- Tất cả cơ sở --</option>
                        @foreach (var item in Model.DanhSachCoSo)
                        {
                            @if (Model.MaCS == item.MaCS)
                            {
                                <option value="@item.MaCS" selected>@item.TenCS</option>
                            }
                            else
                            {
                                <option value="@item.MaCS">@item.TenCS</option>
                            }
                        }
                    </select>
                </div>
                
                <!-- Loại sân -->
                <div class="col-md-2">
                    <label class="form-label text-dark fw-bold ms-1" style="font-size: 0.75rem;"><i class="fas fa-futbol me-1 text-success"></i>LOẠI SÂN</label>
                    <select name="maLS" class="form-select py-2 text-dark fw-bold shadow-sm" style="border-radius: 10px; background: #ffffff; border: 2px solid #e9ecef; font-size: 0.85rem;">
                        <option value="">-- Tất cả loại sân --</option>
                        @foreach (var item in Model.DanhSachLoaiSan)
                        {
                            @if (Model.MaLS == item.MaLS)
                            {
                                <option value="@item.MaLS" selected>@item.TenLS</option>
                            }
                            else
                            {
                                <option value="@item.MaLS">@item.TenLS</option>
                            }
                        }
                    </select>
                </div>

                <!-- Ngày đặt -->
                <div class="col-md-2">
                    <label class="form-label text-dark fw-bold ms-1" style="font-size: 0.75rem;"><i class="fas fa-calendar me-1 text-primary"></i>NGÀY ĐẶT</label>
                    <input type="date" name="ngayDat" value="@Model.NgayDat.ToString("yyyy-MM-dd")" 
                           class="form-control py-2 text-dark fw-bold shadow-sm" 
                           style="border-radius: 10px; background: #ffffff; border: 2px solid #e9ecef; font-size: 0.85rem;" 
                           min="@DateTime.Now.ToString("yyyy-MM-dd")">
                </div>
                
                <!-- Từ giờ -->
                <div class="col-md-2">
                    <label class="form-label text-dark fw-bold ms-1" style="font-size: 0.75rem;"><i class="fas fa-clock me-1 text-info"></i>TỪ GIỜ</label>
                    <input type="time" name="gioBatDau" value="@Model.GioBatDau.ToString(@"hh\:mm")" 
                           class="form-control py-2 text-dark fw-bold shadow-sm" 
                           style="border-radius: 10px; background: #ffffff; border: 2px solid #e9ecef; font-size: 0.85rem;">
                </div>
                
                <!-- Đến giờ -->
                <div class="col-md-2">
                    <label class="form-label text-dark fw-bold ms-1" style="font-size: 0.75rem;"><i class="fas fa-clock me-1 text-danger"></i>ĐẾN GIỜ</label>
                    <input type="time" name="gioKetThuc" value="@Model.GioKetThuc.ToString(@"hh\:mm")" 
                           class="form-control py-2 text-dark fw-bold shadow-sm" 
                           style="border-radius: 10px; background: #ffffff; border: 2px solid #e9ecef; font-size: 0.85rem;">
                </div>
                
                <!-- Nút lọc -->
                <div class="col-md-2">
                    <button type="submit" class="btn w-100 py-2 fw-bold shadow-lg hover-scale" 
                            style="background: var(--color-lime); color: var(--color-dark); border-radius: 10px; border: none; font-size: 0.9rem; margin-top: 1.65rem;">
                        <i class="fas fa-filter me-1"></i> LỌC
                    </button>
                </div>
            </form>
        </div>
    </div>

    @if (ViewBag.Message != null)
    {
        <div class="alert alert-info border-0 shadow-sm rounded-4 mb-4" role="alert">
            <i class="fas fa-info-circle me-2"></i> @ViewBag.Message
        </div>
    }

    <!-- San List -->
    <div class="row g-4">
        @if (Model.DanhSachSanTrong != null && Model.DanhSachSanTrong.Count > 0)
        {
            @foreach (var san in Model.DanhSachSanTrong)
            {
                <div class="col-md-6 col-lg-4 fade-in-up">
                    <div class="card h-100 border-0 shadow-sm hover-elevate position-relative overflow-hidden" 
                         style="border-radius: 20px; background: rgba(255,255,255,0.95);">
                        <!-- Badge Price -->
                        <div class="position-absolute top-0 end-0 m-3 px-3 py-1 rounded-pill fw-bold shadow-sm" 
                             style="background: var(--color-lime); color: var(--color-dark); z-index: 2;">
                            @san.HienThiGia đ/@san.DonViTinh
                        </div>

                        <!-- Card Image Placeholder -->
                        <div class="bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
                            @{
                                var iconClass = "fa-futbol";
                                var colorClass = "text-success";
                                if (san.TenLoaiSan.ToLower().Contains("cầu lông")) { iconClass = "fa-badminton"; colorClass = "text-info"; }
                                else if (san.TenLoaiSan.ToLower().Contains("tennis")) { iconClass = "fa-table-tennis"; colorClass = "text-warning"; }
                                else if (san.TenLoaiSan.ToLower().Contains("bóng rổ")) { iconClass = "fa-basketball-ball"; colorClass = "text-danger"; }
                            }
                            <i class="fas @iconClass fa-5x @colorClass opacity-50"></i>
                        </div>

                        <div class="card-body p-4">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-light text-secondary border me-2">@san.TenCoSo</span>
                                <span class="badge bg-light text-secondary border">@san.TenLoaiSan</span>
                                @if (san.DangBaoTri)
                                {
                                    <span class="badge bg-warning text-dark ms-auto">
                                        <i class="fas fa-wrench me-1"></i>Đang bảo trì
                                    </span>
                                }
                            </div>
                            <h4 class="card-title fw-bold mb-3">@san.TenSan</h4>
                            <div class="d-flex justify-content-between text-secondary small mb-4">
                                <span><i class="fas fa-users me-2"></i>Sức chứa: @san.SucChua người</span>
                            </div>

                            @if (san.DangBaoTri)
                            {
                                <button type="button" class="btn w-100 py-2 fw-bold text-secondary rounded-3 shadow-sm" disabled 
                                        style="background: #e9ecef; cursor: not-allowed; opacity: 0.6;">
                                    <i class="fas fa-wrench me-2"></i>Đang bảo trì
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn w-100 py-2 fw-bold text-white rounded-3 shadow-sm btn-dat-san"
                                        style="background: var(--color-dark);"
                                        data-masan="@san.MaSan" 
                                        data-tensan="@san.TenSan" 
                                        data-tencoso="@san.TenCoSo" 
                                        data-gia="@san.GiaGio.ToString("F0")"
                                        data-dvt="@san.DonViTinh">
                                    Đặt Sân Ngay
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-search fa-4x text-white-50"></i>
                </div>
                <h4 class="text-white-50">Không tìm thấy sân nào phù hợp.</h4>
            </div>
        }
    </div>
</div>

<!-- Modal Dat San -->
<div class="modal fade" id="datSanModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg overflow-hidden" 
             style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="datSanModalLabel">Xác Nhận Đặt Sân</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <!-- ERROR ALERT - Hiển thị lỗi cụ thể -->
                <div id="modalErrorAlert" class="alert alert-danger border-danger d-none mb-4" role="alert" style="border-width: 2px; border-style: solid;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-circle me-3 fs-4"></i>
                        <div>
                            <strong class="d-block mb-1">Lỗi đặt sân</strong>
                            <span id="modalErrorMessage"></span>
                        </div>
                    </div>
                </div>

                <form id="formDatSan">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="modalMaSan" name="SelectedMaSan" />
                    <input type="hidden" asp-for="MaCS" /> <!-- Keep filter state -->
                    <input type="hidden" asp-for="MaLS" /> <!-- Keep filter state -->

                    <div class="alert alert-light border shadow-sm mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold" id="modalTenSan">Sân A</span>
                            <span class="badge bg-success" id="modalGia"></span>
                        </div>
                        <small class="text-secondary" id="modalTenCoSo">Cơ sở 1</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold small text-secondary">Ngày Đặt</label>
                        <input type="date" name="NgayDat" id="NgayDat" class="form-control bg-light border-0 py-2" required min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label fw-semibold small text-secondary">Giờ Bắt Đầu</label>
                            <input type="time" name="GioBatDau" id="GioBatDau" class="form-control bg-light border-0 py-2" required />
                        </div>
                        <div class="col-6">
                            <label class="form-label fw-semibold small text-secondary">Giờ Kết Thúc</label>
                            <input type="time" name="GioKetThuc" id="GioKetThuc" class="form-control bg-light border-0 py-2" required />
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="btn w-100 py-3 fw-bold rounded-3 shadow-sm" 
                                style="background: var(--color-lime); color: var(--color-dark); border: none;">
                            Xác Nhận & Chọn Dịch Vụ <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // ========== XỬ LÝ SUBMIT FORM BẰNG AJAX ==========
            $('#formDatSan').on('submit', function(e) {
                e.preventDefault(); // Ngăn form submit thông thường
                
                // Ẩn lỗi cũ (nếu có)
                $('#modalErrorAlert').addClass('d-none');
                
                // VALIDATION: Kiểm tra thời gian đặt
                var ngayDat = $('#NgayDat').val();
                var gioBatDau = $('#GioBatDau').val();
                var gioKetThuc = $('#GioKetThuc').val();
                
                if (!ngayDat || !gioBatDau || !gioKetThuc) {
                    $('#modalErrorMessage').html('<strong>Vui lòng điền đầy đủ thông tin!</strong>');
                    $('#modalErrorAlert').removeClass('d-none');
                    return;
                }
                
                // Tạo datetime từ ngày và giờ
                var now = new Date();
                var bookingStart = new Date(ngayDat + 'T' + gioBatDau);
                var bookingEnd = new Date(ngayDat + 'T' + gioKetThuc);
                
                // Kiểm tra giờ bắt đầu phải sau giờ hiện tại
                if (bookingStart <= now) {
                    $('#modalErrorMessage').html('<strong>Giờ bắt đầu phải sau thời gian hiện tại!</strong>');
                    $('#modalErrorAlert').removeClass('d-none');
                    $('#modalErrorAlert')[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    return;
                }
                
                // Kiểm tra giờ kết thúc phải sau giờ bắt đầu
                if (bookingEnd <= bookingStart) {
                    $('#modalErrorMessage').html('<strong>Giờ kết thúc phải sau giờ bắt đầu!</strong>');
                    $('#modalErrorAlert').removeClass('d-none');
                    $('#modalErrorAlert')[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    return;
                }
                
                // Kiểm tra đặt Online phải trước 2 tiếng (120 phút)
                var diffMinutes = (bookingStart - now) / (1000 * 60); // Chuyển milliseconds sang phút
                if (diffMinutes < 120) {
                    var hoursLeft = Math.floor(diffMinutes / 60);
                    var minutesLeft = Math.floor(diffMinutes % 60);
                    $('#modalErrorMessage').html('<strong>Đặt Online phải trước 2 tiếng!<br>Hiện tại chỉ còn ' + hoursLeft + ' giờ ' + minutesLeft + ' phút.</strong>');
                    $('#modalErrorAlert').removeClass('d-none');
                    $('#modalErrorAlert')[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    return;
                }
                
                // Gửi AJAX request với form data
                $.ajax({
                    url: '@Url.Action("Index", "DatSan")',
                    type: 'POST',
                    data: $(this).serialize(),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        console.log('AJAX Response:', response); // Debug
                        
                        if (response && response.success) {
                            // Thành công -> Chuyển sang trang chọn dịch vụ
                            window.location.href = response.redirectUrl;
                        } else {
                            // Có lỗi -> Hiển thị lỗi NGAY trong modal (KHÔNG đóng modal)
                            var errorMsg = (response && response.message) ? response.message : 'Có lỗi xảy ra, vui lòng thử lại';
                            $('#modalErrorMessage').html('<strong>' + errorMsg + '</strong>');
                            $('#modalErrorAlert').removeClass('d-none');
                            
                            // Scroll đến lỗi
                            $('#modalErrorAlert')[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            
                            // Nếu cần đăng nhập
                            if (response && response.redirectToLogin) {
                                setTimeout(function() {
                                    window.location.href = '@Url.Action("DangNhap", "TaiKhoan")';
                                }, 2000);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log('AJAX Error:', xhr.status, xhr.responseText); // Debug
                        
                        // Lỗi AJAX - Hiển thị response text nếu có
                        var errorMsg = 'Lỗi kết nối';
                        if (xhr.responseText) {
                            try {
                                var response = JSON.parse(xhr.responseText);
                                errorMsg = response.message || errorMsg;
                            } catch(e) {
                                errorMsg = xhr.status + ': ' + xhr.statusText;
                            }
                        }
                        $('#modalErrorMessage').html('<strong>' + errorMsg + '</strong>');
                        $('#modalErrorAlert').removeClass('d-none');
                    }
                });
            });
            // ==============================================

            // Store current court data
            var currentCourt = {
                gia: 0,
                dvt: 'giờ'
            };

            // Dùng Event Delegation (document on click) để bắt sự kiện cho cả các element được load động
            $(document).on('click', '.btn-dat-san', function(e) {
                e.preventDefault(); // Ngăn hành động mặc định của thẻ A hoặc submit
                
                if (!window.isLoggedIn) {
                    e.stopPropagation();
                    $('#welcomeModal').modal('show');
                    return;
                }

                var maSan = $(this).data('masan');
                var tenSan = $(this).data('tensan');
                var tenCoSo = $(this).data('tencoso');
                currentCourt.gia = parseFloat($(this).data('gia'));
                currentCourt.dvt = $(this).data('dvt') || 'giờ';

                $('#modalMaSan').val(maSan);
                $('#modalTenSan').text(tenSan);
                $('#modalTenCoSo').text(tenCoSo);
                
                // Format price display in header
                var formattedPrice = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(currentCourt.gia);
                
                var unitDisplay = currentCourt.dvt.toLowerCase();
                if (unitDisplay.includes('trận')) unitDisplay = 'trận (90p)';
                else if (unitDisplay.includes('giờ')) unitDisplay = 'giờ';
                
                $('#modalGia').text(formattedPrice + '/' + unitDisplay);
                
                // Ẩn error alert khi mở modal mới
                // Ẩn error alert khi mở modal mới
                $('#modalErrorAlert').addClass('d-none');
                
                // Reset form inputs
                $('#NgayDat').val('');
                $('#GioBatDau').val('');
                $('#GioKetThuc').val('');
                
                // Show modal manually
                $('#datSanModal').modal('show');
            });
        });
    </script>
}
