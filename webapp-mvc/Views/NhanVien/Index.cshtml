@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    ViewData["Title"] = "Phi·∫øu ƒê·∫∑t S√¢n - Nh√¢n Vi√™n";
    var vaiTro = HttpContextAccessor.HttpContext.Session.GetString("VaiTro");
}

<!-- Background Layer -->
<div class="position-fixed top-0 start-0 w-100 h-100" style="z-index: -1; background: #f0fdf4;"></div>

<div class="container py-5 mt-5">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold mb-0" style="color: #065f46;">üìã Phi·∫øu ƒê·∫∑t S√¢n</h2>
                @if (vaiTro != "Thu ng√¢n")
                {
                    <a asp-action="Index" asp-controller="DatSan" class="btn btn-success px-4 py-2 rounded-pill">
                        <i class="fas fa-plus me-2"></i>T·∫°o Phi·∫øu M·ªõi
                    </a>
                }
            </div>

            <!-- Filter Section -->
            <div class="card border-0 shadow-sm rounded-4 mb-4">
                <div class="card-body p-4">
                    <form method="get" asp-action="Index" asp-controller="NhanVien" id="filterForm">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold small" style="color: #065f46;">T·ª´ ng√†y</label>
                                <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold small" style="color: #065f46;">ƒê·∫øn ng√†y</label>
                                <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold small" style="color: #065f46;">Tr·∫°ng th√°i</label>
                                <select name="status" class="form-select">
                                    <option value="">T·∫•t c·∫£</option>
                                    <option value="Ch·ªù thanh to√°n" selected="@(ViewBag.Status == "Ch·ªù thanh to√°n" ? "selected" : null)">Ch·ªù thanh to√°n</option>
                                    <option value="ƒê√£ thanh to√°n" selected="@(ViewBag.Status == "ƒê√£ thanh to√°n" ? "selected" : null)">ƒê√£ thanh to√°n</option>
                                    <option value="ƒê√£ h·ªßy" selected="@(ViewBag.Status == "ƒê√£ h·ªßy" ? "selected" : null)">ƒê√£ h·ªßy</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex gap-2">
                                <button type="submit" class="btn btn-success flex-grow-1 rounded-pill">
                                    <i class="fas fa-filter me-2"></i>L·ªçc
                                </button>
                                <button type="button" class="btn btn-info flex-grow-1 rounded-pill text-white" onclick="toggleStats()">
                                    <i class="fas fa-chart-pie me-2"></i>Bi·ªÉu ƒë·ªì
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Khu v·ª±c Bi·ªÉu ƒë·ªì (Collapse) -->
                    <div class="collapse mt-4" id="statsContainer">
                        <div class="card border border-success border-opacity-25 bg-light rounded-4">
                            <div class="card-body position-relative text-center">
                                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" onclick="toggleStats()"></button>
                                <h5 class="fw-bold text-success mb-3">T·ª∑ l·ªá tr·∫°ng th√°i phi·∫øu ƒë·∫∑t</h5>
                                
                                <div class="row justify-content-center">
                                    <div class="col-md-6" style="height: 300px;">
                                        <canvas id="statusChart"></canvas>
                                    </div>
                                </div>
                                <p class="mt-2 text-muted small fst-italic" id="statsFilterInfo"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (ViewBag.SuccessMessage != null)
            {
                <div class="alert alert-success alert-dismissible fade show rounded-3" role="alert">
                    <i class="fas fa-check-circle me-2"></i>@ViewBag.SuccessMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <!-- ... Table Content skipped ... -->
            <!-- Note: I will only replace the top part and script part. The middle table part remains mostly same but I need to be careful with line numbers. -->
            <!-- Actually, since the Modal was at bottom, I should remove it from bottom and put the container at top. -->
            <!-- Let's replace the Script block completely first, then I will handle the HTML structure carefully. -->
            
            <!-- IMPORTANT: Since I cannot replace non-contiguous blocks easily without messing up, I will do it in 2 steps. -->
            <!-- Step 1: Replace the Script block at the bottom (old script + modal removal) -->
            <!-- Step 2: Adds the Collapse Div near the form. -->
            
            <!-- Wait, the user instruction implies a single action if possible. -->
            <!-- I will replace the SCRIPT section first (Lines ~144 to end). -->


            @if (ViewBag.SuccessMessage != null)
            {
                <div class="alert alert-success alert-dismissible fade show rounded-3" role="alert">
                    <i class="fas fa-check-circle me-2"></i>@ViewBag.SuccessMessage
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (ViewBag.DanhSachPhieu != null && ViewBag.DanhSachPhieu.Rows.Count > 0)
            {
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color: #065f46;">
                                    <tr>
                                        <th class="ps-4 py-3">M√£ Phi·∫øu</th>
                                        <th>Kh√°ch H√†ng</th>
                                        <th>S√¢n</th>
                                        <th>Ng√†y ƒê·∫∑t</th>
                                        <th>Gi·ªù</th>
                                        <th>T·ªïng Ti·ªÅn</th>
                                        <th>Tr·∫°ng Th√°i</th>
                                        <th class="text-center pe-4">Thao T√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (System.Data.DataRow row in ViewBag.DanhSachPhieu.Rows)
                                    {
                                        var trangThai = row["TrangThai"].ToString();
                                        
                                        // Hi·ªÉn th·ªã "ƒê√£ thanh to√°n" cho c·∫£ "ƒê√£ ƒë·∫∑t" v√† "ƒê√£ thanh to√°n"
                                        var displayStatus = (trangThai == "ƒê√£ ƒë·∫∑t" || trangThai == "ƒê√£ thanh to√°n") ? "ƒê√£ thanh to√°n" : trangThai;
                                        
                                        var badgeClass = trangThai == "Ch·ªù thanh to√°n" ? "bg-warning text-dark" : 
                                                        (trangThai == "ƒê√£ thanh to√°n" || trangThai == "ƒê√£ ƒë·∫∑t") ? "bg-success" : 
                                                        trangThai == "ƒê√£ h·ªßy" ? "bg-danger" : "bg-secondary";
                                        
                                        <tr>
                                            <td class="ps-4 py-3 fw-bold">#@row["MaDatSan"]</td>
                                            <td>
                                                <div class="fw-semibold">@row["TenKhachHang"]</div>
                                                <small class="text-muted">@row["SDT"]</small>
                                            </td>
                                            <td>
                                                <div>@(row["TenLS"] + " - " + row["MaSan"])</div>
                                                <small class="text-muted">@row["TenCS"]</small>
                                            </td>
                                            <td>@Convert.ToDateTime(row["NgayDat"]).ToString("dd/MM/yyyy")</td>
                                            <td>
                                                @(((TimeSpan)row["GioBatDau"]).ToString(@"hh\:mm") + " - " + ((TimeSpan)row["GioKetThuc"]).ToString(@"hh\:mm"))
                                            </td>
                                            <td class="fw-bold text-success">
                                                @(row["TienSan"] != DBNull.Value ? Convert.ToDecimal(row["TienSan"]).ToString("N0") : "0") ‚Ç´
                                            </td>
                                            <td>
                                                <span class="badge @badgeClass rounded-pill px-3">@displayStatus</span>
                                            </td>
                                            <td class="text-center pe-4">
                                                <a asp-action="StaffPreview" asp-controller="DatSanThanhToan" 
                                                   asp-route-maDatSan="@row["MaDatSan"]"
                                                   class="btn btn-sm btn-outline-success rounded-pill px-3">
                                                    <i class="fas fa-eye me-1"></i>Xem
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">Ch∆∞a c√≥ phi·∫øu ƒë·∫∑t s√¢n n√†o</h5>
                    <p class="text-muted">H√£y t·∫°o phi·∫øu ƒë·∫∑t s√¢n ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
                    <a asp-action="Index" asp-controller="DatSan" class="btn btn-success px-4 py-2 rounded-pill mt-2">
                        <i class="fas fa-plus me-2"></i>T·∫°o Phi·∫øu M·ªõi
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<!-- Chart.js & Datalabels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    // Register plugin globally
    Chart.register(ChartDataLabels);

    let myChart = null;

    function toggleStats() {
        const container = document.getElementById('statsContainer');
        const bsCollapse = new bootstrap.Collapse(container, { toggle: false });
        
        if (container.classList.contains('show')) {
            bsCollapse.hide();
        } else {
            loadStatsData();
            bsCollapse.show();
        }
    }

    function loadStatsData() {
        const fromDate = document.querySelector('input[name="fromDate"]').value;
        const toDate = document.querySelector('input[name="toDate"]').value;

        fetch(`/NhanVien/GetBookingStats?fromDate=${fromDate}&toDate=${toDate}`)
            .then(response => response.json())
            .then(res => {
                if (res.success) {
                    renderChart(res.data);
                    
                    let filterText = "D·ªØ li·ªáu t√≠nh tr√™n t·∫•t c·∫£ th·ªùi gian";
                    if (fromDate && toDate) filterText = `D·ªØ li·ªáu t·ª´ ${formatDateV2(fromDate)} ƒë·∫øn ${formatDateV2(toDate)}`;
                    else if (fromDate) filterText = `D·ªØ li·ªáu t·ª´ ${formatDateV2(fromDate)}`;
                    else if (toDate) filterText = `D·ªØ li·ªáu ƒë·∫øn ${formatDateV2(toDate)}`;
                    document.getElementById('statsFilterInfo').innerText = filterText;
                } else {
                    alert("L·ªói t·∫£i th·ªëng k√™: " + res.message);
                }
            })
            .catch(err => console.error(err));
    }

    function renderChart(data) {
        const ctx = document.getElementById('statusChart').getContext('2d');
        
        const labels = data.map(item => item.label);
        const values = data.map(item => item.count);
        const total = values.reduce((a, b) => a + b, 0);
        
        // Colors Logic (Improved Order)
        const bgColors = labels.map(label => {
            let l = label.toLowerCase();
            if (l.includes("hu·ª∑") || l.includes("h·ªßy") || l.includes("no-show")) return '#ef4444'; // Red (Cancelled)
            if (l.includes("ch·ªù")) return '#f59e0b'; // Yellow/Orange (Pending)
            if (l.includes("thanh to√°n") || l.includes("ƒë√£ ƒë·∫∑t") || l.includes("ho√†n th√†nh")) return '#10b981'; // Green (Success)
            return '#6b7280'; // Gray (Other)
        });

        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'pie', // Pie chart is good for ratios
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: bgColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right', // Legend on right looks cleaner for dropdown
                        labels: {
                            font: { size: 12 },
                            boxWidth: 15
                        }
                    },
                    datalabels: {
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 14
                        },
                        formatter: (value, ctx) => {
                            if (value === 0) return "";
                            let percentage = (value * 100 / total).toFixed(1) + "%";
                            return percentage; // Show only % on the slice
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.parsed || 0;
                                let pct = (value * 100 / total).toFixed(1) + "%";
                                return `${label}: ${value} phi·∫øu (${pct})`;
                            }
                        }
                    }
                }
            }
        });
    }

    function formatDateV2(dateStr) {
        if (!dateStr) return "";
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    }
</script>
