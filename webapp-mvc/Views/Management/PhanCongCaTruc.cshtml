@{
    ViewData["Title"] = "Phân Công Ca Trực";
}

<style>
    .calendar-container {
        animation: fadeIn 0.6s ease-out;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .shift-badge {
        display: block;
        padding: 0.4rem 0.6rem;
        border-radius: 8px;
        font-size: 0.75rem;
        margin-bottom: 0.3rem;
        font-weight: 600;
        text-align: center;
        transition: all 0.2s ease;
        animation: slideIn 0.3s ease-out;
    }

    @@keyframes slideIn {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .shift-badge:hover {
        transform: scale(1.05);
    }

    .shift-morning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffc107 100%);
        color: #856404;
    }

    .shift-afternoon {
        background: linear-gradient(135deg, #cfe2ff 0%, #0d6efd 100%);
        color: #084298;
    }

    .shift-evening {
        background: linear-gradient(135deg, #e2d5f0 0%, #6f42c1 100%);
        color: #432874;
    }

    .shift-full {
        background: linear-gradient(135deg, #d1e7dd 0%, #198754 100%);
        color: #0f5132;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    .calendar-day-header {
        text-align: center;
        font-weight: 700;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        color: #495057;
    }

    .calendar-day {
        min-height: 120px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.75rem;
        background: white;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .calendar-day:hover {
        border-color: #a3cf06;
        box-shadow: 0 4px 12px rgba(163, 207, 6, 0.2);
        transform: translateY(-2px);
    }

    .calendar-day.today {
        border-color: #a3cf06;
        background: linear-gradient(135deg, #f0f8e0 0%, #e8f5d5 100%);
    }

    .calendar-day.other-month {
        opacity: 0.4;
        background: #f8f9fa;
    }

    .day-number {
        font-weight: 700;
        font-size: 1.1rem;
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .legend {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 6px;
    }

    .employee-chip {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        background: #e9ecef;
        border-radius: 20px;
        font-size: 0.85rem;
        margin: 0.2rem;
        transition: all 0.2s ease;
    }

    .employee-chip:hover {
        background: #a3cf06;
        color: white;
        transform: scale(1.05);
    }
</style>

<!-- Hero Banner -->
<div class="position-relative w-100 d-flex align-items-center justify-content-center mb-4" 
     style="height: 400px; background: url('https://blog.comparasoftware.com/wp-content/uploads/2020/06/Gestion-de-Proyectos-Tecnologicos.jpg') center/cover no-repeat; padding-top: 85px; z-index: 1;">
    <!-- Green Gradient Overlay -->
    <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(29, 78, 36, 0.85) 0%, rgba(76, 175, 80, 0.75) 50%, rgba(163, 207, 6, 0.65) 100%);"></div>
    
    <div class="text-center position-relative px-3" style="z-index: 2;">
        <h1 class="display-3 fw-bold text-white mb-3" style="text-shadow: 0 4px 12px rgba(0,0,0,0.4);">
            <i class="fas fa-calendar-alt me-3"></i>PHÂN CÔNG CA TRỰC
        </h1>
        <p class="lead text-light fs-5 opacity-90" style="text-shadow: 0 2px 8px rgba(0,0,0,0.3);">
            Quản lý lịch làm việc và phân công nhân viên
        </p>
    </div>
</div>

<div class="container py-4 calendar-container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-outline-secondary rounded-pill" onclick="previousMonth()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h4 class="mb-0 fw-bold" id="currentMonth">Tháng 1, 2026</h4>
                    <button class="btn btn-outline-secondary rounded-pill" onclick="nextMonth()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn rounded-pill px-4 shadow" style="background: #d9f02b; color: #111; font-weight: 600;" data-bs-toggle="modal" data-bs-target="#createShiftModal">
                    <i class="fas fa-plus me-2"></i>
                    Tạo Ca Trực
                </button>
            </div>
        </div>

        <!-- Legend -->
        <div class="legend mt-3">
            <div class="legend-item">
                <div class="legend-color shift-morning"></div>
                <span><strong>Sáng</strong> (6:00 - 12:00)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color shift-afternoon"></div>
                <span><strong>Chiều</strong> (12:00 - 18:00)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color shift-evening"></div>
                <span><strong>Tối</strong> (18:00 - 22:00)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color shift-full"></div>
                <span><strong>Cả ngày</strong></span>
            </div>
        </div>
    </div>

    <!-- Calendar Grid (Month View) -->
    <div id="monthView" class="calendar-grid">
        <!-- Day Headers -->
        <div class="calendar-day-header">Chủ Nhật</div>
        <div class="calendar-day-header">Thứ Hai</div>
        <div class="calendar-day-header">Thứ Ba</div>
        <div class="calendar-day-header">Thứ Tư</div>
        <div class="calendar-day-header">Thứ Năm</div>
        <div class="calendar-day-header">Thứ Sáu</div>
        <div class="calendar-day-header">Thứ Bảy</div>

        <!-- Days will be injected by JS -->
    </div>

    <!-- list view intentionally removed — only month calendar shown -->
</div>

<!-- Create Shift Modal -->
<div class="modal fade" id="createShiftModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 15px;">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, rgba(29, 78, 36, 0.9) 0%, rgba(163, 207, 6, 0.9) 100%); color: white;">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-plus-circle me-2"></i>
                    Tạo Ca Trực Mới
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Ngày làm việc</label>
                            <input type="date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Ca trực</label>
                            <select class="form-select" required>
                                <option value="">Chọn ca...</option>
                                <option value="morning">Sáng (6:00 - 12:00)</option>
                                <option value="afternoon">Chiều (12:00 - 18:00)</option>
                                <option value="evening">Tối (18:00 - 22:00)</option>
                                <option value="full">Cả ngày</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Nhân viên</label>
                            <select class="form-select" multiple size="5" required>
                                @{
                                    var staffObj = ViewBag.StaffList as System.Collections.IEnumerable ?? System.Linq.Enumerable.Empty<object>();
                                    foreach (var sObj in staffObj)
                                    {
                                        string maNV = "";
                                        string hoTen = "";
                                        string chucVu = "";

                                        if (sObj is System.Data.DataRow dr)
                                        {
                                            maNV = dr.Table.Columns.Contains("MaNV") ? dr["MaNV"]?.ToString() ?? "" : "";
                                            hoTen = dr.Table.Columns.Contains("HoTen") ? dr["HoTen"]?.ToString() ?? "" : "";
                                            chucVu = dr.Table.Columns.Contains("ChucVu") ? dr["ChucVu"]?.ToString() ?? "" : "";
                                        }
                                        else if (sObj is System.Collections.IDictionary dictObj)
                                        {
                                            var dict = dictObj;
                                            if (dict.Contains("MaNV")) maNV = dict["MaNV"]?.ToString() ?? "";
                                            if (dict.Contains("HoTen")) hoTen = dict["HoTen"]?.ToString() ?? "";
                                            if (dict.Contains("ChucVu")) chucVu = dict["ChucVu"]?.ToString() ?? "";
                                        }
                                        else
                                        {
                                            var t = sObj?.GetType();
                                            var p1 = t?.GetProperty("MaNV");
                                            var p2 = t?.GetProperty("HoTen");
                                            var p3 = t?.GetProperty("ChucVu");
                                            if (p1 != null) maNV = p1.GetValue(sObj)?.ToString() ?? "";
                                            if (p2 != null) hoTen = p2.GetValue(sObj)?.ToString() ?? "";
                                            if (p3 != null) chucVu = p3.GetValue(sObj)?.ToString() ?? "";
                                        }

                                        <text><option value="@maNV">@hoTen - @chucVu</option></text>
                                    }
                                }
                            </select>
                            <small class="text-muted">Giữ Ctrl/Cmd để chọn nhiều nhân viên</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Ghi chú</label>
                            <textarea class="form-control" rows="3" placeholder="Ghi chú về ca trực..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn rounded-pill px-4 shadow" style="background: #d9f02b; color: #111; font-weight: 600;">
                    <i class="fas fa-save me-2"></i>
                    Tạo Ca Trực
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Calendar state
    let currentView = 'month';
    let currentFrom = new Date();

    function formatDateIso(d) {
        const y = d.getFullYear();
        const m = (d.getMonth() + 1).toString().padStart(2, '0');
        const day = d.getDate().toString().padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function previousMonth() {
        currentFrom.setMonth(currentFrom.getMonth() - 1);
        loadShifts();
    }

    function nextMonth() {
        currentFrom.setMonth(currentFrom.getMonth() + 1);
        loadShifts();
    }

    function changeView(view, btn) {
        currentView = view;
        document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
        loadShifts();
    }

    async function loadShifts() {
        const start = new Date(currentFrom.getFullYear(), currentFrom.getMonth(), 1);
        document.getElementById('currentMonth').textContent = start.toLocaleString('vi-VN', { month: 'long', year: 'numeric' });
        const fromIso = formatDateIso(start);
        try {
            const res = await fetch(`@Url.Action("GetLichCaTruc","Management")?view=${currentView}&from=${fromIso}`);
            const payload = await res.json();
            console.log('loadShifts payload:', payload);
            if (!payload.success) throw new Error(payload.message || 'Không thể tải dữ liệu');
            renderMonthGrid(payload.data);
        } catch (err) {
            console.error(err);
            alert('Lỗi tải lịch trực: ' + err.message);
        }
    }

    function renderMonthGrid(shifts) {
        const grid = document.getElementById('monthView');
        // Clear days (keep headers)
        Array.from(grid.querySelectorAll('.calendar-day')).forEach(n => n.remove());

        const year = currentFrom.getFullYear();
        const month = currentFrom.getMonth();
        const firstDay = new Date(year, month, 1);
        const startDayOfWeek = firstDay.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // prepend previous month's trailing days
        const prevMonthDays = startDayOfWeek; // number of empty cells before day 1
        const totalCells = Math.ceil((prevMonthDays + daysInMonth) / 7) * 7;

        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            const dayIndex = i - prevMonthDays + 1;
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';

            if (dayIndex < 1 || dayIndex > daysInMonth) {
                cell.classList.add('other-month');
                dayNumber.textContent = '';
            } else {
                const date = new Date(year, month, dayIndex);
                dayNumber.textContent = dayIndex;
                if (date.toDateString() === new Date().toDateString()) cell.classList.add('today');

                // find shifts for this date (compare dates by YYYY-MM-DD strings)
                const dateKey = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
                console.log('Checking date:', dateKey, 'Total shifts:', shifts.length);
                const dayShifts = shifts.filter(s => {
                    try {
                        const shiftDate = s.ngayTruc.substring(0, 10); // Extract 'YYYY-MM-DD' from '2026-01-15T00:00:00'
                        console.log(`  Comparing shift ${s.maCaTruc}: "${shiftDate}" === "${dateKey}" ?`, shiftDate === dateKey);
                        return shiftDate === dateKey;
                    } catch (e) {
                        console.error('Error parsing ngayTruc:', s.ngayTruc, e);
                        return false;
                    }
                });
                console.log('Matched shifts for', dateKey, ':', dayShifts.length);
                if (dayShifts.length) console.log('Shifts on', dateKey, dayShifts);
                dayShifts.forEach(s => {
                    const badge = document.createElement('div');
                    badge.className = 'shift-badge';
                    
                    // Determine color based on time slot
                    const startHour = s.gioBatDau ? parseInt(s.gioBatDau.split(':')[0]) : 0;
                    if (startHour >= 6 && startHour < 12) {
                        badge.classList.add('shift-morning'); // Yellow for morning (6-12)
                    } else if (startHour >= 12 && startHour < 18) {
                        badge.classList.add('shift-afternoon'); // Blue for afternoon (12-18)
                    } else if (startHour >= 18 && startHour < 24) {
                        badge.classList.add('shift-evening'); // Purple for evening (18-22)
                    } else {
                        badge.classList.add('shift-full'); // Green default
                    }
                    
                    badge.dataset.maca = s.maCaTruc;
                    badge.style.cursor = 'pointer';
                    badge.onclick = () => openShiftDetail(s.maCaTruc);
                    
                    // Create badge content with time, name, and position
                    let badgeHtml = `<div style="font-weight: 600; margin-bottom: 2px;">${s.tenCa}</div>`;
                    if (s.hoTen) {
                        badgeHtml += `<div style="font-size: 0.85em; opacity: 0.95;">${s.hoTen}</div>`;
                        if (s.chucVu) {
                            badgeHtml += `<div style="font-size: 0.75em; opacity: 0.85;">${s.chucVu}</div>`;
                        }
                    } else {
                        badgeHtml += `<div style="font-size: 0.85em; opacity: 0.7; font-style: italic;">Chưa phân công</div>`;
                    }
                    badge.innerHTML = badgeHtml;
                    cell.appendChild(badge);
                });
            }

            cell.prepend(dayNumber);
            grid.appendChild(cell);
        }
    }

    async function openShiftDetail(maCaTruc) {
        try {
            const res = await fetch(`@Url.Action("GetChiTietCa","Management")?maCaTruc=${maCaTruc}`);
            const payload = await res.json();
            if (!payload.success) throw new Error(payload.message || 'Không thể tải chi tiết ca');
            const data = payload.data;
            // Build modal content
            let html = `<h5 class="fw-bold">Chi tiết ca trực</h5>`;
            html += `<p class="text-muted">Mã: ${maCaTruc}</p>`;
            html += `<div class="mb-2"><strong>Ca:</strong> ${data[0].TenCa} - ${new Date(data[0].NgayTruc).toLocaleDateString('vi-VN')}</div>`;
            html += `<div class="mb-2"><strong>Thời gian:</strong> ${data[0].GioBatDau} - ${data[0].GioKetThuc}</div>`;
            html += `<div class="mb-2"><strong>Nhân viên tham gia:</strong><div id="assignedList">`;
            data.forEach(d => {
                if (d.MaNV) html += `<div class="employee-chip">${d.HoTen} <button class="btn btn-sm btn-link text-danger ms-2" onclick="unassign('${maCaTruc}','${d.MaNV}')"><i class='fas fa-times'></i></button></div>`;
            });
            html += `</div></div>`;
            html += `<div class="mt-3"><label class="form-label">Phân công thêm nhân viên</label><select id="assignSelect" class="form-select"></select><div class="mt-2"><button class="btn btn-success" onclick="assignStaff('${maCaTruc}')">Phân công</button> <button class="btn btn-secondary" onclick="closeModal('shiftDetailModal')">Đóng</button></div></div>`;

            // show modal (simple bootstrap modal)
            let modalRoot = document.getElementById('shiftDetailModal');
            if (!modalRoot) {
                modalRoot = document.createElement('div');
                modalRoot.id = 'shiftDetailModal';
                modalRoot.className = 'modal fade';
                modalRoot.tabIndex = -1;
                modalRoot.innerHTML = `<div class="modal-dialog"><div class="modal-content"><div class="modal-body" id="shiftDetailBody"></div></div></div>`;
                document.body.appendChild(modalRoot);
            }
            document.getElementById('shiftDetailBody').innerHTML = html;

            // populate assign select with available staff
            const staffRes = await fetch('@Url.Action("GetStaffForReplacement","LichLamViec")');
            const staffPayload = await staffRes.json();
            const sel = document.getElementById('assignSelect');
            sel.innerHTML = '';
            if (staffPayload.success) {
                staffPayload.data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.maNV;
                    opt.text = `${s.hoTen} - ${s.chucVu}`;
                    sel.appendChild(opt);
                });
            }

            new bootstrap.Modal(modalRoot).show();
        } catch (err) {
            console.error(err);
            alert('Lỗi: ' + err.message);
        }
    }

    async function assignStaff(maCaTruc) {
        const sel = document.getElementById('assignSelect');
        const maNV = sel.value;
        if (!maNV) { alert('Chọn nhân viên để phân công'); return; }
        try {
            const res = await fetch('@Url.Action("AssignNhanVien","Management")', {
                method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `maCaTruc=${encodeURIComponent(maCaTruc)}&maNV=${encodeURIComponent(maNV)}`
            });
            const payload = await res.json();
            if (!payload.success) throw new Error(payload.message || 'Lỗi phân công');
            alert(payload.message);
            loadShifts();
            // close modal
            closeModal('shiftDetailModal');
        } catch (err) {
            alert('Lỗi: ' + err.message);
        }
    }

    async function unassign(maCaTruc, maNV) {
        if (!confirm('Xóa phân công nhân viên này?')) return;
        try {
            // simple approach: remove row from THAMGIACATRUC by deleting then refresh
            // there is no dedicated endpoint; we'll call Management/XoaCaTruc if necessary for full delete
            const sqlRes = await fetch('@Url.Action("GetChiTietCa","Management")?maCaTruc=' + maCaTruc);
            // fallback: ask backend to delete and re-create remaining assignments is complex - for now refresh
            // In practice a new endpoint should be added for unassigning a single staff.
            alert('Hành động gỡ phân công: hãy sử dụng trang Nhân sự nếu cần. (temporary)');
            loadShifts();
            closeModal('shiftDetailModal');
        } catch (err) {
            alert('Lỗi: ' + err.message);
        }
    }

    function closeModal(id) {
        const el = document.getElementById(id);
        if (!el) return;
        const modal = bootstrap.Modal.getInstance(el);
        if (modal) modal.hide();
    }

    // Create shift submit: map selected shift type to times, include selected employees
    document.querySelectorAll('#createShiftModal .modal-footer .btn-primary').forEach(btn => {
        btn.addEventListener('click', async () => {
            const modal = document.getElementById('createShiftModal');
            const dateInput = modal.querySelector('input[type="date"]');
            const shiftSelect = modal.querySelector('select');
            const staffSelect = modal.querySelector('select[multiple]');
            const ghiChuEl = modal.querySelector('textarea');

            const ngayTruc = dateInput?.value;
            const shiftType = shiftSelect?.value || '';
            const ghiChu = ghiChuEl?.value || '';

            if (!ngayTruc) { alert('Chọn ngày'); return; }

            // map shift type to start/end times
            let gioBatDau = '08:00', gioKetThuc = '17:00';
            switch (shiftType) {
                case 'morning': gioBatDau = '06:00'; gioKetThuc = '12:00'; break;
                case 'afternoon': gioBatDau = '12:00'; gioKetThuc = '18:00'; break;
                case 'evening': gioBatDau = '18:00'; gioKetThuc = '22:00'; break;
                case 'full': gioBatDau = '08:00'; gioKetThuc = '17:00'; break;
                default: break;
            }

            // collect selected employees (use value if present, otherwise text)
            const selectedStaff = [];
            if (staffSelect) {
                Array.from(staffSelect.options).forEach(opt => {
                    if (opt.selected) selectedStaff.push(opt.value && opt.value.trim() !== '' ? opt.value : opt.text.trim());
                });
            }

            try {
                // build form body with repeated maNVs fields
                const params = new URLSearchParams();
                params.append('ngayTruc', ngayTruc);
                params.append('tenCa', shiftType || 'Ca');
                params.append('gioBatDau', gioBatDau);
                params.append('gioKetThuc', gioKetThuc);
                params.append('ghiChu', ghiChu);
                selectedStaff.forEach(s => params.append('maNVs', s));

                const res = await fetch('@Url.Action("CreateCaTruc","Management")', {
                    method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params.toString()
                });
                const payload = await res.json();
                if (!payload.success) throw new Error(payload.message || 'Lỗi tạo ca');
                alert(payload.message);
                new bootstrap.Modal(modal).hide();
                loadShifts();
            } catch (err) {
                alert('Lỗi: ' + err.message);
            }
        });
    });

    // initial load
    document.addEventListener('DOMContentLoaded', () => {
        // set initial date to first of current month
        const now = new Date();
        currentFrom = new Date(now.getFullYear(), now.getMonth(), 1);
        loadShifts();
    });
</script>
