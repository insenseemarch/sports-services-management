@model webapp_mvc.Models.LichLamViecViewModel
@{
    ViewData["Title"] = "Lịch Làm Việc";
    
    // Calendar Logic Helpers
    var currentCulture = new System.Globalization.CultureInfo("vi-VN");
    var startDate = Model.FromDate.Date;
    var endDate = Model.ToDate.Date;
    
    // Calculate start/end to fill full weeks (Simulate Calendar Grid)
    // VN start week on Monday (1). Sunday is 0.
    int startOffset = (int)startDate.DayOfWeek == 0 ? 6 : (int)startDate.DayOfWeek - 1;
    var calendarStart = startDate.AddDays(-startOffset);
    
    int endOffset = (int)endDate.DayOfWeek == 0 ? 0 : 7 - (int)endDate.DayOfWeek;
    // If user selected full month, usually endDate is last day.
    var calendarEnd = endDate.AddDays(endOffset);

    int totalDays = (int)(calendarEnd - calendarStart).TotalDays + 1;
}

<!-- Custom Styles for Calendar -->
<style>
    :root {
        --color-lime-dark: #3f6212;
        --color-lime-primary: #a3cf06;
        --color-lime-light: #ecfccb;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #e5e7eb; /* Border color */
        border: 1px solid #e5e7eb;
        border-radius: 0 0 1rem 1rem;
        overflow: hidden;
    }
    
    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background-color: #f8fafc;
        border-radius: 1rem 1rem 0 0;
        border: 1px solid #e5e7eb;
        border-bottom: none;
    }
    
    .calendar-cell {
        background-color: white;
        min-height: 140px;
        padding: 10px;
        transition: all 0.2s;
        position: relative;
    }
    
    .calendar-cell:hover {
        background-color: #fafafa;
    }
    
    .calendar-cell.other-month {
        background-color: #f9fafb;
    }
    
    .calendar-cell.today {
        background-color: #f0fdf4;
    }
    
    .calendar-cell.today .day-number {
        background-color: var(--color-lime-primary);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .shift-tag {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 6px;
        margin-bottom: 4px;
        cursor: pointer;
        transition: transform 0.2s;
        border-left: 3px solid transparent;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .shift-tag:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    
    .shift-completed { background-color: #dcfce7; color: #166534; border-left-color: #166534; }
    .shift-active { background-color: #fef9c3; color: #854d0e; border-left-color: #854d0e; animation: pulse-soft 2s infinite; }
    .shift-upcoming { background-color: #eff6ff; color: #1e40af; border-left-color: #1e40af; }
    
    @@keyframes pulse-soft {
        0% { opacity: 1; }
        50% { opacity: 0.8; }
        100% { opacity: 1; }
    }
</style>

<!-- Background Full -->
<div class="position-fixed top-0 start-0 w-100 h-100" style="z-index: -1; background: #f8fafc;"></div>

<div class="container-fluid p-0 mb-5">
    <!-- Header Banner -->
    <div class="position-relative shadow-sm" style="border-bottom: 1px solid #e5e7eb; margin-top: -100px; padding-bottom: 80px;"> <!-- Increased negative margin and bottom padding -->
        <div class="position-absolute w-100 h-100 overflow-hidden">
            <!-- Deep Eco-Green Gradient -->
            <div class="w-100 h-100" style="background: linear-gradient(135deg, #15803d 0%, #14532d 100%);"></div>
            <!-- Subtle pattern -->
            <div class="position-absolute w-100 h-100" style="background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 30px 30px; opacity: 0.2;"></div>
            <!-- Decorative curves -->
            <div class="position-absolute bottom-0 start-0 w-100">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" style="margin-bottom: -1px;">
                    <path fill="#ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
                </svg>
            </div>
        </div>
        
        <!-- Main Content Area - Increased Top Padding to 180px -->
        <div class="container position-relative" style="padding-top: 180px;">
            <div class="row justify-content-center text-center">
                <div class="col-lg-8 text-white">
                    <h1 class="fw-bold display-5 mb-3 d-flex align-items-center justify-content-center text-shadow-sm">
                        <i class="fas fa-calendar-check me-3 text-warning"></i>Quản Lý Lịch Làm Việc
                    </h1>
                    <p class="mb-5 fs-5 opacity-90 fw-light">Theo dõi ca trực và quản lý thời gian nghỉ ngơi của bạn.</p>
                </div>
            </div>
        </div>
        
        <!-- Floating Filter Bar - Positioned Absolute Overlap -->
        <div class="container position-absolute start-50 translate-middle-x" style="bottom: -35px; z-index: 10;">
             <div class="bg-white p-4 rounded-3 shadow-lg border border-success border-opacity-25">
                <form method="get" class="row g-3 align-items-end justify-content-center">
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-success small text-uppercase"><i class="fas fa-calendar-day me-1"></i>Từ ngày</label>
                        <input type="date" name="fromDate" value="@Model.FromDate.ToString("yyyy-MM-dd")" class="form-control fw-bold border-success bg-light">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-success small text-uppercase"><i class="fas fa-calendar-week me-1"></i>Đến ngày</label>
                        <input type="date" name="toDate" value="@Model.ToDate.ToString("yyyy-MM-dd")" class="form-control fw-bold border-success bg-light">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-success small text-uppercase"><i class="fas fa-info-circle me-1"></i>Trạng thái</label>
                        <select class="form-select fw-bold border-success bg-light text-dark">
                            <option>Tất cả</option>
                            <option>Ca sắp tới</option>
                            <option>Đã hoàn thành</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-success fw-bold shadow-sm text-uppercase py-2" 
                                style="background: linear-gradient(to right, #15803d, #166534); border: none;">
                            <i class="fas fa-filter me-2"></i>Lọc
                        </button>
                    </div>
                    <!-- Reset Button -->
                    <div class="col-auto">
                         <a href="@Url.Action("LichLamViec", "NhanVien")" class="btn btn-outline-secondary border-0" data-bs-toggle="tooltip" title="Đặt lại (Tháng này)">
                            <i class="fas fa-sync-alt"></i>
                        </a>
                    </div>
                </form>
             </div>
        </div>
    </div>

    <!-- Spacer for Floating Bar overlap -->
    <div class="container pt-5 mt-4">
        <!-- Stats Row -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                    <div class="card-body p-4 d-flex align-items-center">
                        <div class="rounded-circle p-3 me-3 text-white" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            <i class="fas fa-calendar-alt fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-muted text-uppercase small fw-bold mb-1">Tổng Số Ca</p>
                            <h2 class="fw-bold mb-0 text-dark">@Model.TongSoCa</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                    <div class="card-body p-4 d-flex align-items-center">
                        <div class="rounded-circle p-3 me-3 text-white" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-muted text-uppercase small fw-bold mb-1">Đã Hoàn Thành</p>
                            <h2 class="fw-bold mb-0 text-success">@Model.SoCaDaLam</h2>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                    <div class="card-body p-4 d-flex align-items-center">
                        <div class="rounded-circle p-3 me-3 text-white" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-muted text-uppercase small fw-bold mb-1">Sắp Tới</p>
                            <h2 class="fw-bold mb-0 text-warning">@Model.SoCaSapToi</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <ul class="nav nav-pills bg-white p-1 rounded-pill shadow-sm border" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active rounded-pill px-4 fw-bold" id="pills-calendar-tab" data-bs-toggle="pill" data-bs-target="#pills-calendar" type="button">
                        <i class="fas fa-th me-2"></i>Lịch (Calendar)
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link rounded-pill px-4 fw-bold" id="pills-list-tab" data-bs-toggle="pill" data-bs-target="#pills-list" type="button">
                        <i class="fas fa-list me-2"></i>Danh Sách
                    </button>
                </li>
            </ul>
            
            <button class="btn btn-primary rounded-pill shadow fw-bold px-4 py-2" data-bs-toggle="modal" data-bs-target="#modalXinNghi" style="background-color: var(--color-lime-dark); border:none;">
                <i class="fas fa-plus-circle me-2"></i>Xin Nghỉ Phép
            </button>
        </div>
        
        <!-- Notifications -->
        @if (ViewBag.SuccessMessage != null)
        {
            <div class="alert alert-success rounded-4 shadow-sm border-0 d-flex align-items-center mb-4" role="alert">
                <i class="fas fa-check-circle fa-2x me-3 text-success"></i>
                <div>
                    <h6 class="fw-bold mb-0">Thành công!</h6>
                    <span>@ViewBag.SuccessMessage</span>
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        }

        <div class="tab-content" id="pills-tabContent">
            <!-- VIEW 1: CALENDAR (Separated by Month) -->
            <div class="tab-pane fade show active" id="pills-calendar" role="tabpanel">
                @{
                    var iterator = new DateTime(Model.FromDate.Year, Model.FromDate.Month, 1);
                    var endDateLoop = new DateTime(Model.ToDate.Year, Model.ToDate.Month, 1).AddMonths(1).AddDays(-1);
                    // Ensure we don't loop forever if dates are weird, but logic implies iterator increases
                }

                @while (iterator <= endDateLoop && iterator <= Model.ToDate.AddMonths(1)) // Safety check
                {
                    var daysInMonth = DateTime.DaysInMonth(iterator.Year, iterator.Month);
                    var firstDayOfMonth = new DateTime(iterator.Year, iterator.Month, 1);
                    // Calculate Offset: Monday(1)=0, ..., Sunday(0)=6
                    int monthStartOffset = (int)firstDayOfMonth.DayOfWeek == 0 ? 6 : (int)firstDayOfMonth.DayOfWeek - 1;
                    
                    <div class="mb-5 shadow-sm rounded-4 overflow-hidden bg-white border">
                        <!-- Month Header -->
                        <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                            <h4 class="fw-bold text-success m-0 text-capitalize">
                                <i class="fas fa-calendar-alt me-2"></i>Tháng @iterator.ToString("MM / yyyy")
                            </h4>
                        </div>

                        <!-- Days of Week Header -->
                        <div class="calendar-header p-2 bg-light border-bottom">
                            <div class="fw-bold py-2 rounded-3 text-center text-white shadow-sm mx-1" style="background: linear-gradient(135deg, #10b981, #059669);">TH 2</div>
                            <div class="fw-bold py-2 rounded-3 text-center text-white shadow-sm mx-1" style="background: linear-gradient(135deg, #10b981, #059669);">TH 3</div>
                            <div class="fw-bold py-2 rounded-3 text-center text-white shadow-sm mx-1" style="background: linear-gradient(135deg, #10b981, #059669);">TH 4</div>
                            <div class="fw-bold py-2 rounded-3 text-center text-white shadow-sm mx-1" style="background: linear-gradient(135deg, #10b981, #059669);">TH 5</div>
                            <div class="fw-bold py-2 rounded-3 text-center text-white shadow-sm mx-1" style="background: linear-gradient(135deg, #10b981, #059669);">TH 6</div>
                            <div class="fw-bold py-2 rounded-3 text-center text-white shadow-sm mx-1" style="background: linear-gradient(135deg, #f59e0b, #d97706);">TH 7</div>
                            <div class="fw-bold py-2 rounded-3 text-center text-white shadow-sm mx-1" style="background: linear-gradient(135deg, #ef4444, #b91c1c);">CN</div>
                        </div>

                        <!-- Calendar Grid for this Month -->
                        <div class="calendar-grid">
                            <!-- Empty Cells for Offset -->
                            @for (int k = 0; k < monthStartOffset; k++)
                            {
                                <div class="calendar-cell other-month bg-light opacity-50"></div>
                            }

                            <!-- Days -->
                            @for (int d = 1; d <= daysInMonth; d++)
                            {
                                var currentDate = new DateTime(iterator.Year, iterator.Month, d);
                                bool isToday = currentDate.Date == DateTime.Now.Date;
                                // Simple list filtering for this day
                                var shifts = Model.DanhSachCaTruc.Where(x => x.NgayTruc.Date == currentDate.Date).OrderBy(x => x.GioBatDau).ToList();
                                var leaves = Model.DanhSachDonNghi.Where(x => x.NgayNghi.Date == currentDate.Date).ToList();

                                <div class="calendar-cell @(isToday ? "today" : "")">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <span class="day-number fw-bold @(isToday ? "" : "text-dark")">@d</span>
                                        @if (leaves.Any())
                                        {
                                            <span class="badge bg-danger rounded-circle p-1" style="width: 8px; height: 8px;" title="Có đơn nghỉ phép"></span>
                                        }
                                    </div>

                                    <div class="shift-list">
                                        @foreach (var shift in shifts)
                                        {
                                            string statusClass = shift.TrangThai == "Đã làm" ? "shift-completed" : (shift.TrangThai == "Đang trực" ? "shift-active" : "shift-upcoming");
                                            <div class="shift-tag @statusClass" title="Ca: @shift.GioBatDau.ToString(@"hh\:mm") - @shift.GioKetThuc.ToString(@"hh\:mm") | @shift.TrangThai">
                                                <div class="fw-bold">@shift.GioBatDau.ToString(@"hh\:mm")</div>
                                                <div class="small opacity-75" style="font-size: 10px;">@shift.TrangThai</div>
                                            </div>
                                        }
                                        @foreach (var leave in leaves)
                                        {
                                            <div class="shift-tag bg-danger bg-opacity-10 text-danger border-start border-danger">
                                                <div class="fw-bold"><i class="fas fa-file-alt me-1"></i>Nghỉ</div>
                                                <div class="small opacity-75" style="font-size: 10px;">@leave.TrangThai</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            
                            <!-- Fill remaining cells to make grid nice (optional) -->
                            @{
                                int totalCellsFilled = monthStartOffset + daysInMonth;
                                int remainingCells = 7 - (totalCellsFilled % 7);
                                if (remainingCells < 7) {
                                    for(int r=0; r<remainingCells; r++) {
                                        <div class="calendar-cell other-month bg-light opacity-50"></div>
                                    }
                                }
                            }
                        </div>
                    </div>
                    
                    iterator = iterator.AddMonths(1);
                }
            </div>

            <!-- VIEW 2: LIST (Existing Table) -->
            <div class="tab-pane fade" id="pills-list" role="tabpanel">
                <div class="card border-0 shadow-lg rounded-4 overflow-hidden mb-5">
                    <div class="card-header bg-white py-3 border-bottom">
                        <h5 class="fw-bold mb-0 text-dark"><i class="fas fa-list me-2 text-primary"></i>Danh Sách Ca Trực</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead style="background-color: #f8fafc;">
                                    <tr>
                                        <th class="py-3 ps-4 text-secondary text-uppercase small fw-bold">Ngày</th>
                                        <th class="py-3 text-secondary text-uppercase small fw-bold">Ca trực</th>
                                        <th class="py-3 text-secondary text-uppercase small fw-bold">Thời gian</th>
                                        <th class="py-3 text-secondary text-uppercase small fw-bold text-center">Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.DanhSachCaTruc)
                                    {
                                        <tr>
                                            <td class="ps-4 fw-bold">@item.NgayTruc.ToString("dd/MM/yyyy")</td>
                                            <td><span class="badge bg-light text-dark border">@item.ThuTrongTuan</span></td>
                                            <td>@item.GioBatDau.ToString(@"hh\:mm") - @item.GioKetThuc.ToString(@"hh\:mm")</td>
                                            <td class="text-center">
                                                <span class="badge @(item.TrangThai=="Đã làm"?"bg-success": (item.TrangThai=="Đang trực"?"bg-warning":"bg-primary"))">@item.TrangThai</span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History of Leave Requests (Always Visible or in Modal? Let's keep it below) -->
        <div class="mt-5">
            <h4 class="fw-bold text-dark mb-3"><i class="fas fa-history me-2 text-warning"></i>Lịch Sử Đơn Nghỉ Phép</h4>
             <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3">Ngày xin nghỉ</th>
                                <th class="py-3">Ca</th>
                                <th class="py-3">Lý do</th>
                                <th class="py-3 text-center">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                             @if (Model.DanhSachDonNghi.Any())
                             {
                                 @foreach (var don in Model.DanhSachDonNghi)
                                 {
                                     <tr>
                                         <td class="ps-4 fw-bold">@don.NgayNghi.ToString("dd/MM/yyyy")</td>
                                         <td class="text-muted small">@don.CaNghiInfo</td>
                                         <td>@don.LyDo</td>
                                         <td class="text-center">
                                             @if(don.TrangThai == "Chờ duyệt") { 
                                                 <span class="badge bg-warning bg-opacity-25 text-warning-emphasis border border-warning border-opacity-25 rounded-pill px-3">
                                                     <i class="fas fa-hourglass-half me-1"></i>@don.TrangThai
                                                 </span> 
                                             }
                                             else if(don.TrangThai == "Đã duyệt") { 
                                                 <span class="badge bg-success bg-opacity-25 text-success border border-success border-opacity-25 rounded-pill px-3">
                                                     <i class="fas fa-check me-1"></i>@don.TrangThai
                                                 </span> 
                                             }
                                             else { 
                                                 <span class="badge bg-danger bg-opacity-25 text-danger border border-danger border-opacity-25 rounded-pill px-3">
                                                     <i class="fas fa-times me-1"></i>@don.TrangThai
                                                 </span> 
                                             }
                                         </td>
                                     </tr>
                                 }
                             }
                             else
                             {
                                 <tr><td colspan="4" class="text-center py-4 text-muted">Chưa có dữ liệu</td></tr>
                             }
                        </tbody>
                    </table>
                </div>
             </div>
        </div>
    </div>
</div>

<!-- Modal Xin Nghỉ Phép -->
<div class="modal fade" id="modalXinNghi" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <form class="modal-content rounded-4 border-0 shadow-lg" method="post" action="@Url.Action("XinNghiPhep")">
      <!-- Header -->
      <div class="modal-header border-0 pb-0 pt-4 px-4 align-items-start">
         <div class="d-flex align-items-center">
             <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3 text-success">
                 <i class="fas fa-file-signature fa-2x"></i>
             </div>
             <div>
                <h4 class="modal-title fw-bold text-dark mb-1">Đơn Xin Nghỉ Phép</h4>
                <p class="text-muted small mb-0">Vui lòng điền đầy đủ thông tin để gửi yêu cầu phê duyệt.</p>
             </div>
         </div>
         <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body p-4">
         <div class="row g-3">
             <!-- Thông tin cá nhân -->
             <div class="col-md-6">
                 <label class="form-label fw-bold small text-uppercase text-secondary">Người làm đơn</label>
                 <div class="input-group">
                     <span class="input-group-text bg-light border-0"><i class="fas fa-user text-muted"></i></span>
                     <input type="text" class="form-control bg-light border-0 fw-bold" value="@(Model.TenNhanVien)" readonly>
                 </div>
             </div>
             <div class="col-md-6">
                  <label class="form-label fw-bold small text-uppercase text-secondary">Người thay thế (Cùng vị trí)</label>
                  <div class="input-group">
                      <span class="input-group-text bg-white border"><i class="fas fa-user-friends text-muted"></i></span>
                      <select name="nguoiThayThe" class="form-select border">
                          <option value="">-- Chọn người thay thế --</option>
                          @if(Model.DanhSachDongNghiep != null) {
                              foreach(var nv in Model.DanhSachDongNghiep) {
                                  <option value="@nv.MaNV">@nv.HoTen</option>
                              }
                          }
                      </select>
                  </div>
             </div>
             
             <!-- Chọn Ca -->
             <div class="col-12">
                  <label class="form-label fw-bold small text-uppercase text-secondary mb-2">Chọn Ca Nghỉ <span class="text-danger">*</span></label>
                  
                  @if (Model.CaTrucCoTheNghi != null && Model.CaTrucCoTheNghi.Count > 0)
                  {
                      <div class="list-group border-0 pe-1 custom-scrollbar" style="max-height: 300px; overflow-y: auto;">
                          @foreach(var ca in Model.CaTrucCoTheNghi) {
                              <label class="list-group-item list-group-item-action d-flex align-items-center mb-2 rounded border shadow-sm p-3" style="cursor: pointer; transition: all 0.2s;">
                                  <input class="form-check-input me-3 border-success flex-shrink-0" type="radio" name="maCaTruc" value="@ca.MaCaTruc" required style="width: 1.4em; height: 1.4em; margin-top: 0;">
                                  <div class="flex-grow-1">
                                      <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                          <span class="fw-bold text-dark">@ca.ThuTrongTuan, @ca.NgayTruc.ToString("dd/MM/yyyy")</span>
                                          <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3">Sắp tới</span>
                                      </div>
                                      <div class="text-secondary small">
                                          <i class="far fa-clock me-1 text-success"></i>
                                          <span class="fw-medium">@ca.GioBatDau.ToString(@"hh\:mm")</span> - <span class="fw-medium">@ca.GioKetThuc.ToString(@"hh\:mm")</span>
                                      </div>
                                  </div>
                              </label>
                          }
                      </div>
                  }
                  else
                  {
                      <div class="alert alert-light border border-dashed text-center py-4 text-muted">
                          <i class="fas fa-calendar-times fs-2 mb-2 d-block text-secondary"></i>
                          Chưa có ca trực nào sắp tới hoặc bạn đã xin nghỉ hết rồi.
                      </div>
                  }
             </div>
             
             <!-- Lý do -->
             <div class="col-12">
                  <label class="form-label fw-bold small text-uppercase text-secondary">Lý do xin nghỉ <span class="text-danger">*</span></label>
                  <textarea name="lyDo" class="form-control" rows="4" required placeholder="Ghi rõ lý do (Ví dụ: Ốm, Bận việc gia đình...)" style="resize: none;"></textarea>
             </div>
         </div>
         
         <div class="form-check mt-4 bg-light p-3 rounded-3 border border-secondary border-opacity-10">
             <input class="form-check-input" type="checkbox" required id="confirmCheck">
             <label class="form-check-label small text-muted" for="confirmCheck">
                 Tôi cam kết các thông tin khai báo là trung thực và chịu trách nhiệm về đơn này.
             </label>
         </div>
      </div>
      
      <div class="modal-footer border-0 px-4 pb-4 justify-content-between">
        <button type="button" class="btn btn-outline-secondary rounded-pill px-4 fw-bold" data-bs-dismiss="modal">
            <i class="fas fa-arrow-left me-2"></i>Quay lại
        </button>
        <button type="submit" class="btn btn-success rounded-pill px-5 fw-bold shadow-sm text-uppercase" style="background: linear-gradient(to right, #16a34a, #15803d); border: none;">
            <i class="fas fa-paper-plane me-2"></i>Gửi Đơn
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Success -->
<div class="modal fade" id="modalSuccess" tabindex="-1" style="z-index: 1060;" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0 shadow-lg text-center p-4" style="background: rgba(255, 255, 255, 0.98);">
             <div class="mb-3 text-success">
                 <i class="fas fa-check-circle fa-5x animate__animated animate__bounceIn"></i>
             </div>
             <h4 class="fw-bold mb-2 text-success">Gửi Thành Công!</h4>
             <p class="text-muted small mb-0">Đơn nghỉ phép đang chờ duyệt.</p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var showSuccess = '@TempData["ShowSuccessModal"]';
        
        if (showSuccess && showSuccess.toLowerCase() === 'true') {
            var successEl = document.getElementById('modalSuccess');
            // Dùng constructor trực tiếp để đảm bảo control
            var myModal = new bootstrap.Modal(successEl, {
                backdrop: false, // Không dùng backdrop đen để trông nhẹ nhàng hơn
                keyboard: false
            });
            
            myModal.show();
            
            // Tự động tắt sau 2 giây và dọn dẹp sạch sẽ
            setTimeout(function() {
                myModal.hide();
                
                // Cleanup phòng hờ
                var backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(b => b.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 2000);
        }
    });
</script>
